---
# file: ops/ansible/ancillary-minio.yml
# osparc-simcore ancillary deployment playbook - minio
- hosts: docker-hosts
  roles:
    - dockerhost
    - minio

# Deploy minio stack
# Deploy Minio docker swarm stack
- hosts: docker-swarm-managers[0]
  become: yes
  become_method: sudo
  tasks:
  - name: Package pwgen is installed
    apt:
      pkg: pwgen
    # Key removal will fail if key does not already exist.  This is OK, if a bit ugly.
    # ToDo: dangerous, these keys need their own namespace: e.g. minio_access_key, so we don't delete some other necessary key in the future
  - name: Remove docker secret access_key
    shell: "docker secret rm access_key"
    ignore_errors: yes
  - name: Remove docker secret secret_key
    shell: "docker secret rm secret_key"
    ignore_errors: yes
  - name: Generate minio access key
    command: "/usr/bin/pwgen -sB 20 1"
    register: access_key
    changed_when: False
  - name: Generate minio secret key
    command: "/usr/bin/pwgen -sB 32 1"
    register: secret_key
    changed_when: False
  - name: Create docker secret access_key
    shell: "echo {{ access_key.stdout }} | /usr/bin/docker secret create access_key -"
    retries: 3
    delay: 20
    register: result
    until: result.rc == 0
  - name: Create docker secret secret_key
    shell: "echo {{ secret_key.stdout }} | /usr/bin/docker secret create secret_key -"
    retries: 3
    delay: 20
    register: result
    until: result.rc == 0
  - name: Create directory for local docker-compose file
    file:
      path: "/tmp/osparc-simcore/ops/ansible/roles/minio/files"
      state: directory
      group: docker
      mode: 0775
  - name: example copying file with owner and permissions
    copy:
      src: "./roles/minio/files/docker-compose.yml"
      dest: "/tmp/osparc-simcore/ops/ansible/roles/minio/files/docker-compose.yml"
      owner: root
      group: docker
      mode: 0644
  - name: Deploy minio stack
    command: "/usr/bin/docker stack deploy --compose-file=/tmp/osparc-simcore/ops/ansible/roles/minio/files/docker-compose.yml minio"
  - debug: 
      msg: "Minio Access Key: {{ access_key.stdout }}"
  - debug:
      var: "Minio Secret Key: {{ secret_key.stdout }}"