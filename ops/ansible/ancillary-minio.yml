---
# file: ops/ansible/ancillary-minio.yml
# osparc-simcore ancillary deployment playbook - minio
- hosts: docker-hosts
  roles:
    - dockerhost
    - minio

# Deploy minio stack
# Deploy Minio docker swarm stack
- hosts: docker-swarm-managers[0]
  become: yes
  become_method: sudo
  tasks:
  - name: Package pwgen is installed
    apt:
      pkg: pwgen
    # Key removal will fail if key does not already exist.  This is OK, if a bit ugly.
    # ToDo: dangerous, these keys need their own namespace: e.g. minio_access_key, so we don't delete some other necessary key in the future
  - name: Remove docker secret access_key
    shell: "docker secret rm access_key"
    ignore_errors: yes
  - name: Remove docker secret secret_key
    shell: "docker secret rm secret_key"
    ignore_errors: yes
  - name: Generate minio access key
    command: "/usr/bin/pwgen -sB 20 1"
    register: access_key
    changed_when: False
  - name: Generate minio secret key
    command: "/usr/bin/pwgen -sB 32 1"
    register: secret_key
    changed_when: False
  - name: Create docker secret access_key
    shell: "echo {{ access_key }} | /usr/bin/docker secret create access_key -"
    retries: 3
    delay: 20
    register: result
    until: result.rc == 0
  - name: Create docker secret secret_key
    shell: "echo {{ secret_key }} | /usr/bin/docker secret create secret_key -"
    retries: 3
    delay: 20
    register: result
    until: result.rc == 0
  - name: Deploy minio stack
    command: "/usr/bin/docker stack deploy --compose-file={{ role_path }}/files/docker-compose.yml minio"
  - debug: 
      var: access_key
  - debug:
      var: secret_key