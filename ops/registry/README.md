# AWS-S3 Registry

These are instructions for setting up the private docker repository hosted on AWS using a bucket in S3 and ssl certificates generated by [letsencypt](https://letsencrypt.org). Those are minimal instructions. For more details please refer to

- [docker repository setup](https://www.digitalocean.com/community/tutorials/how-to-set-up-a-private-docker-registry-on-ubuntu-14-04)
- [letsencrypt instructions](https://www.cb-net.co.uk/linux/using-lets-encrypt-with-an-nginx-docker-container-plus-bye-bye-startssl/)

## Prerequisites

Create a new ec2 instance running Ubuntu 16.04 with the following settings

- subnet: ```simcore-dev```:
- add contents of ```install-docker.sh``` to Advanced Details
- security-group: ```simcore private``
- associate elastic ip address with this instance (registry record in simcore.io in Route 53)
- create S3 bucket ```simcore-registry```
- make sure you have your accesskey and secretkey ready

## Registry setup

- copy the content of this directory into the home directory of the ec2 instance
- login and move into that folder (```~/registry```)
- ```docker-compose up -d```
- ```sh setup.sh```
- ```docker-compose down```
- ```cd nginx/conf.d```
- ```htpasswd -c registry.password USERNAME and create new pwd when prompted```
- ```export REGISTRY_USER=USERNAME```
- ```export REGISTRY_PW=PW```
- edit storage/s3/accesskey and storage/s3/secretkey in ```simcore-registry-config.yaml``` to match you AWS account credentials
- remove comments in ```nginx/conf.d```
- from ```~/registry``` ```docker-compose up -d```

## Volume mount setup

See `docker-compose-from-volume.yml`

## Deleting images
This is a bit cumbersome but here is how it works when the registry backend is a mounted named volume

```
docker run --rm anoxis/registry-cli -l z43:z43 -r https://masu.speag.com -i simcore/dag --delete-all
docker-compose stop
docker-compose run --rm registry bin/registry garbage-collect /etc/docker/registry/config.yml
sudo rm -rf data/docker/registry/v2/repositories/simcore/dag
docker-compose up -d
```
