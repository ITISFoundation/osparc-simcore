# pylint: disable=redefined-outer-name
# pylint: disable=unused-argument
# pylint: disable=unused-variable

import asyncio
from collections.abc import Awaitable, Callable

import pytest
from aiohttp.test_utils import TestClient
from servicelib.aiohttp.application import create_safe_application
from simcore_service_webserver._meta import api_version_prefix
from simcore_service_webserver.catalog.client import to_backend_service
from simcore_service_webserver.catalog.plugin import setup_catalog
from yarl import URL


@pytest.fixture
def client(
    event_loop: asyncio.AbstractEventLoop,
    aiohttp_client: Callable[..., Awaitable[TestClient]],
):
    app = create_safe_application()

    setup_catalog.__wrapped__(app)

    return event_loop.run_until_complete(aiohttp_client(app))


def test_url_translation():
    front_url = URL(
        f"https://osparc.io/{api_version_prefix}/catalog/dags/123?page_size=6"
    )

    rel_url = front_url.relative()
    assert rel_url.path.startswith(f"/{api_version_prefix}/catalog")

    api_target_origin = URL("http://catalog:8000")
    api_target_url = to_backend_service(rel_url, api_target_origin, "v5")

    assert str(api_target_url) == "http://catalog:8000/v5/dags/123?page_size=6"
