version: "3.8"
services:
  api-server:
    image: ${DOCKER_REGISTRY:-itisfoundation}/api-server:${DOCKER_IMAGE_TAG:-latest}
    init: true
    hostname: "{{.Node.Hostname}}-{{.Service.Name}}-{{.Task.Slot}}"
    environment:
      - WEBSERVER_HOST=${WEBSERVER_HOST:-webserver}
      - LOG_LEVEL=${LOG_LEVEL:-WARNING}
      - LOG_FORMAT_LOCAL_DEV_ENABLED=${LOG_FORMAT_LOCAL_DEV_ENABLED}
    env_file:
      - ../.env
    deploy:
      labels:
        - io.simcore.zone=${TRAEFIK_SIMCORE_ZONE}
        # gzip compression
        - traefik.http.middlewares.${SWARM_STACK_NAME}_gzip.compress=true
        # ssl header necessary so that socket.io upgrades correctly from polling to websocket mode. the middleware must be attached to the right connection.
        - traefik.enable=true
        - traefik.http.services.${SWARM_STACK_NAME}_api-server.loadbalancer.server.port=8000
        - traefik.http.services.${SWARM_STACK_NAME}_api-server.loadbalancer.healthcheck.path=/
        - traefik.http.services.${SWARM_STACK_NAME}_api-server.loadbalancer.healthcheck.interval=2000ms
        - traefik.http.services.${SWARM_STACK_NAME}_api-server.loadbalancer.healthcheck.timeout=1000ms
        - traefik.http.routers.${SWARM_STACK_NAME}_api-server.rule=hostregexp(`{host:.+}`) && (Path(`/`, `/v0`) ||  PathPrefix(`/v0/`) || Path(`/api/v0/openapi.json`))
        - traefik.http.routers.${SWARM_STACK_NAME}_api-server.entrypoints=simcore_api
        - traefik.http.routers.${SWARM_STACK_NAME}_api-server.priority=1
        - traefik.http.routers.${SWARM_STACK_NAME}_api-server.middlewares=${SWARM_STACK_NAME}_gzip@docker,ratelimit-${SWARM_STACK_NAME}_api-server
    networks:
      - default

  autoscaling:
    image: ${DOCKER_REGISTRY:-itisfoundation}/autoscaling:${DOCKER_IMAGE_TAG:-latest}
    init: true
    hostname: "{{.Node.Hostname}}-{{.Service.Name}}-{{.Task.Slot}}"
    networks:
      - autoscaling_subnet
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-WARNING}
      - LOG_FORMAT_LOCAL_DEV_ENABLED=${LOG_FORMAT_LOCAL_DEV_ENABLED}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
    deploy:
      placement:
        constraints:
          - node.role == manager
      resources:
        reservations:
          cpus: "0.5"
          memory: "512M"
        limits:
          cpus: "0.5"
          memory: "512M"

  catalog:
    image: ${DOCKER_REGISTRY:-itisfoundation}/catalog:${DOCKER_IMAGE_TAG:-latest}
    init: true
    hostname: "{{.Node.Hostname}}-{{.Service.Name}}-{{.Task.Slot}}"
    environment:
      - CATALOG_BACKGROUND_TASK_REST_TIME=${CATALOG_BACKGROUND_TASK_REST_TIME:-60}
      - CATALOG_DEV_FEATURES_ENABLED=${CATALOG_DEV_FEATURES_ENABLED}
      - CATALOG_SERVICES_DEFAULT_RESOURCES=${CATALOG_SERVICES_DEFAULT_RESOURCES}
      - CATALOG_SERVICES_DEFAULT_SPECIFICATIONS=${CATALOG_SERVICES_DEFAULT_SPECIFICATIONS}
      - DIRECTOR_HOST=${DIRECTOR_HOST:-director}
      - DIRECTOR_PORT=${DIRECTOR_PORT:-8080}
      - LOG_LEVEL=${LOG_LEVEL:-WARNING}
      - LOG_FORMAT_LOCAL_DEV_ENABLED=${LOG_FORMAT_LOCAL_DEV_ENABLED}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_PORT=${POSTGRES_PORT}
      - POSTGRES_USER=${POSTGRES_USER}
      - TRACING_THRIFT_COMPACT_ENDPOINT=${TRACING_THRIFT_COMPACT_ENDPOINT}
    networks:
      - default

  director:
    image: ${DOCKER_REGISTRY:-itisfoundation}/director:${DOCKER_IMAGE_TAG:-latest}
    init: true
    hostname: "{{.Node.Hostname}}-{{.Service.Name}}-{{.Task.Slot}}"
    environment:
      - DEFAULT_MAX_MEMORY=${DEFAULT_MAX_MEMORY:-0}
      - DEFAULT_MAX_NANO_CPUS=${DEFAULT_MAX_NANO_CPUS:-0}
      - DIRECTOR_REGISTRY_CACHING_TTL=${DIRECTOR_REGISTRY_CACHING_TTL}
      - DIRECTOR_REGISTRY_CACHING=${DIRECTOR_REGISTRY_CACHING}
      - DIRECTOR_SELF_SIGNED_SSL_FILENAME=${DIRECTOR_SELF_SIGNED_SSL_FILENAME}
      - DIRECTOR_SELF_SIGNED_SSL_SECRET_ID=${DIRECTOR_SELF_SIGNED_SSL_SECRET_ID}
      - DIRECTOR_SELF_SIGNED_SSL_SECRET_NAME=${DIRECTOR_SELF_SIGNED_SSL_SECRET_NAME}
      - DIRECTOR_SERVICES_CUSTOM_CONSTRAINTS=${DIRECTOR_SERVICES_CUSTOM_CONSTRAINTS}
      - EXTRA_HOSTS_SUFFIX=${EXTRA_HOSTS_SUFFIX:-undefined}
      - LOGLEVEL=${LOG_LEVEL:-WARNING}
      - MONITORING_ENABLED=${MONITORING_ENABLED:-True}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_ENDPOINT=${POSTGRES_ENDPOINT}
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_PORT=${POSTGRES_PORT}
      - POSTGRES_USER=${POSTGRES_USER}
      - REGISTRY_AUTH=${REGISTRY_AUTH}
      - REGISTRY_PATH=${REGISTRY_PATH}
      - REGISTRY_PW=${REGISTRY_PW}
      - REGISTRY_SSL=${REGISTRY_SSL}
      - REGISTRY_URL=${REGISTRY_URL}
      - REGISTRY_USER=${REGISTRY_USER}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME}
      - S3_ENDPOINT=${S3_ENDPOINT}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
      - SIMCORE_SERVICES_NETWORK_NAME=interactive_services_subnet
      - STORAGE_ENDPOINT=${STORAGE_ENDPOINT}
      - SWARM_STACK_NAME=${SWARM_STACK_NAME:-simcore}
      - TRACING_ENABLED=${TRACING_ENABLED:-True}
      - TRACING_ZIPKIN_ENDPOINT=${TRACING_ZIPKIN_ENDPOINT:-http://jaeger:9411}
      - TRAEFIK_SIMCORE_ZONE=${TRAEFIK_SIMCORE_ZONE:-internal_simcore_stack}
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
    deploy:
      placement:
        constraints:
          - node.role == manager
    networks:
      - default
      - interactive_services_subnet

  director-v2:
    image: ${DOCKER_REGISTRY:-itisfoundation}/director-v2:${DOCKER_IMAGE_TAG:-latest}
    init: true
    hostname: "{{.Node.Hostname}}-{{.Service.Name}}-{{.Task.Slot}}"
    environment:
      - CATALOG_HOST=${CATALOG_HOST:-catalog}
      - CATALOG_PORT=${CATALOG_PORT:-8000}
      - COMPUTATIONAL_BACKEND_DEFAULT_CLUSTER_URL=${COMPUTATIONAL_BACKEND_DEFAULT_CLUSTER_URL:-tcp://dask-scheduler:8786}
      - DIRECTOR_HOST=${DIRECTOR_HOST:-director}
      - DIRECTOR_PORT=${DIRECTOR_PORT:-8080}
      - DIRECTOR_SELF_SIGNED_SSL_FILENAME=${DIRECTOR_SELF_SIGNED_SSL_FILENAME}
      - DIRECTOR_SELF_SIGNED_SSL_SECRET_ID=${DIRECTOR_SELF_SIGNED_SSL_SECRET_ID}
      - DIRECTOR_SELF_SIGNED_SSL_SECRET_NAME=${DIRECTOR_SELF_SIGNED_SSL_SECRET_NAME}
      - DIRECTOR_SERVICES_CUSTOM_CONSTRAINTS=${DIRECTOR_SERVICES_CUSTOM_CONSTRAINTS}
      - DIRECTOR_V2_DEV_FEATURES_ENABLED=${DIRECTOR_V2_DEV_FEATURES_ENABLED}
      - DYNAMIC_SIDECAR_IMAGE=${DOCKER_REGISTRY:-itisfoundation}/dynamic-sidecar:${DOCKER_IMAGE_TAG:-latest}
      - EXTRA_HOSTS_SUFFIX=${EXTRA_HOSTS_SUFFIX:-undefined}
      - LOG_LEVEL=${LOG_LEVEL:-WARNING}
      - LOG_FORMAT_LOCAL_DEV_ENABLED=${LOG_FORMAT_LOCAL_DEV_ENABLED}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME}
      - S3_ENDPOINT=${S3_ENDPOINT}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
      - R_CLONE_PROVIDER=${R_CLONE_PROVIDER}
      - MONITORING_ENABLED=${MONITORING_ENABLED:-True}
      - SIMCORE_SERVICES_NETWORK_NAME=interactive_services_subnet
      - TRACING_THRIFT_COMPACT_ENDPOINT=${TRACING_THRIFT_COMPACT_ENDPOINT}
    env_file:
      - ../.env
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
    deploy:
      placement:
        constraints:
          - node.role == manager
    networks:
      - default
      - interactive_services_subnet
      - computational_services_subnet

  invitations:
    image: ${DOCKER_REGISTRY:-itisfoundation}/invitations:${DOCKER_IMAGE_TAG:-latest}
    init: true
    hostname: "{{.Node.Hostname}}-{{.Service.Name}}-{{.Task.Slot}}"
    networks:
      - default
    environment:
      - INVITATIONS_LOGLEVEL=${LOG_LEVEL:-INFO}
      - INVITATIONS_SECRET_KEY=${INVITATIONS_SECRET_KEY}
      - INVITATIONS_OSPARC_URL=${INVITATIONS_OSPARC_URL}
      - INVITATIONS_USERNAME=${INVITATIONS_USERNAME}
      - INVITATIONS_PASSWORD=${INVITATIONS_PASSWORD}
      - LOG_FORMAT_LOCAL_DEV_ENABLED=${LOG_FORMAT_LOCAL_DEV_ENABLED}

  resource-usage-tracker:
    image: ${DOCKER_REGISTRY:-itisfoundation}/resource-usage-tracker:${DOCKER_IMAGE_TAG:-latest}
    init: true
    hostname: "{{.Node.Hostname}}-{{.Service.Name}}-{{.Task.Slot}}"
    networks:
      - default
    environment:
      - LOG_FORMAT_LOCAL_DEV_ENABLED=${LOG_FORMAT_LOCAL_DEV_ENABLED}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_ENDPOINT=${POSTGRES_ENDPOINT}
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_PORT=${POSTGRES_PORT}
      - POSTGRES_USER=${POSTGRES_USER}
      - PROMETHEUS_URL=${RESOURCE_USAGE_TRACKER_PROMETHEUS_URL}
      - PROMETHEUS_USERNAME=${RESOURCE_USAGE_TRACKER_PROMETHEUS_USERNAME}
      - PROMETHEUS_PASSWORD=${RESOURCE_USAGE_TRACKER_PROMETHEUS_PASSWORD}
      - RESOURCE_USAGE_TRACKER_LOGLEVEL=${LOG_LEVEL:-INFO}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - RABBIT_HOST=${RABBIT_HOST}
      - RABBIT_PASSWORD=${RABBIT_PASSWORD}
      - RABBIT_PORT=${RABBIT_PORT}
      - RABBIT_SECURE=${RABBIT_SECURE}
      - RABBIT_USER=${RABBIT_USER}

  static-webserver:
    image: ${DOCKER_REGISTRY:-itisfoundation}/static-webserver:${DOCKER_IMAGE_TAG:-latest}
    init: true
    hostname: "{{.Node.Hostname}}-{{.Service.Name}}-{{.Task.Slot}}"
    environment:
      - SERVER_HOST=0.0.0.0
      - SERVER_PORT=8000
      - SERVER_LOG_LEVEL=error
      - SERVER_ROOT=/static-content
    deploy:
      labels:
        - io.simcore.zone=${TRAEFIK_SIMCORE_ZONE}
        - traefik.http.middlewares.${SWARM_STACK_NAME}_gzip.compress=true
        - traefik.enable=true
        - traefik.http.services.${SWARM_STACK_NAME}_static_webserver.loadbalancer.server.port=8000
        - traefik.http.services.${SWARM_STACK_NAME}_static_webserver.loadbalancer.healthcheck.path=/
        - traefik.http.services.${SWARM_STACK_NAME}_static_webserver.loadbalancer.healthcheck.interval=2000ms
        - traefik.http.services.${SWARM_STACK_NAME}_static_webserver.loadbalancer.healthcheck.timeout=1000ms
        - traefik.http.middlewares.${SWARM_STACK_NAME}_static_webserver_retry.retry.attempts=2
        - traefik.http.routers.${SWARM_STACK_NAME}_static_webserver.rule=hostregexp(`{host:.+}`) && (Path(`/osparc`,`/s4l`,`/s4llite`,`/tis`,`/transpiled`,`/resource`) || PathPrefix(`/osparc/`,`/s4l/`,`/s4llite/`,`/tis/`,`/transpiled/`,`/resource/`))
        - traefik.http.routers.${SWARM_STACK_NAME}_static_webserver.service=${SWARM_STACK_NAME}_static_webserver
        - traefik.http.routers.${SWARM_STACK_NAME}_static_webserver.entrypoints=http
        - traefik.http.routers.${SWARM_STACK_NAME}_static_webserver.priority=2
        - traefik.http.routers.${SWARM_STACK_NAME}_static_webserver.middlewares=${SWARM_STACK_NAME}_gzip@docker,${SWARM_STACK_NAME}_static_webserver_retry
        # catchall for legacy services (this happens if a backend disappears and a frontend tries to reconnect, the right return value is a 503)
        - traefik.http.routers.${SWARM_STACK_NAME}_legacy_services_catchall.service=${SWARM_STACK_NAME}_legacy_services_catchall
        - traefik.http.routers.${SWARM_STACK_NAME}_legacy_services_catchall.priority=1
        - traefik.http.routers.${SWARM_STACK_NAME}_legacy_services_catchall.entrypoints=http
        - traefik.http.routers.${SWARM_STACK_NAME}_legacy_services_catchall.rule=hostregexp(`{host:.+}`) && (Path(`/x/{node_uuid:\b[0-9a-f]{8}\b-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-\b[0-9a-f]{12}\b}`) || PathPrefix(`/x/{node_uuid:\b[0-9a-f]{8}\b-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-\b[0-9a-f]{12}\b}/`))
        # this tricks traefik into a 502 (bad gateway) since the service does not exist on this port
        - traefik.http.services.${SWARM_STACK_NAME}_legacy_services_catchall.loadbalancer.server.port=0
        # this tricks traefik into returning a 503 (service unavailable) since the healthcheck will always return false
        - traefik.http.services.${SWARM_STACK_NAME}_legacy_services_catchall.loadbalancer.healthcheck.path=/some/invalid/path/to/generate/a/503
        - traefik.http.services.${SWARM_STACK_NAME}_legacy_services_catchall.loadbalancer.healthcheck.interval=500s
        - traefik.http.services.${SWARM_STACK_NAME}_legacy_services_catchall.loadbalancer.healthcheck.timeout=1ms
        # see [#2718](https://github.com/ITISFoundation/osparc-simcore/issues/2718)
        # catchall for dy-sidecar powered-services (this happens if a backend disappears and a frontend tries to reconnect, the right return value is a 503)
        - traefik.http.routers.${SWARM_STACK_NAME}_modern_services_catchall.service=${SWARM_STACK_NAME}_modern_services_catchall
        # the priority is a bit higher than webserver, the webserver is the fallback to everything and has prio 2
        - traefik.http.routers.${SWARM_STACK_NAME}_modern_services_catchall.priority=3
        - traefik.http.routers.${SWARM_STACK_NAME}_modern_services_catchall.entrypoints=http
        # in theory the pattern should be uuid.services.OSPARC_DOMAIN, but anything could go through.. so let's catch everything
        - traefik.http.routers.${SWARM_STACK_NAME}_modern_services_catchall.rule=hostregexp(`{node_uuid:.+}.services.{host:.+}`)
        # this tricks traefik into a 502 (bad gateway) since the service does not exist on this port
        - traefik.http.services.${SWARM_STACK_NAME}_modern_services_catchall.loadbalancer.server.port=0
        # this tricks traefik into returning a 503 (service unavailable) since the healthcheck will always return false
        - traefik.http.services.${SWARM_STACK_NAME}_modern_services_catchall.loadbalancer.healthcheck.path=/some/invalid/path/to/generate/a/503
        - traefik.http.services.${SWARM_STACK_NAME}_modern_services_catchall.loadbalancer.healthcheck.interval=500s
        - traefik.http.services.${SWARM_STACK_NAME}_modern_services_catchall.loadbalancer.healthcheck.timeout=1ms
    networks:
      - default

  webserver:
    image: ${DOCKER_REGISTRY:-itisfoundation}/webserver:${DOCKER_IMAGE_TAG:-latest}
    init: true
    hostname: "{{.Node.Hostname}}-{{.Service.Name}}-{{.Task.Slot}}"
    environment:
      AIODEBUG_SLOW_DURATION_SECS: ${AIODEBUG_SLOW_DURATION_SECS}

      SWARM_STACK_NAME: ${SWARM_STACK_NAME}

      WEBSERVER_DEV_FEATURES_ENABLED: ${WEBSERVER_DEV_FEATURES_ENABLED}

      WEBSERVER_LOGLEVEL: ${WEBSERVER_LOGLEVEL}

      WEBSERVER_LOG_FORMAT_LOCAL_DEV_ENABLED: ${LOG_FORMAT_LOCAL_DEV_ENABLED}

      # WEBSERVER_SERVER_HOST

      WEBSERVER_HOST: ${WEBSERVER_HOST}

      # WEBSERVER_SERVER_PORT

      WEBSERVER_FRONTEND: ${WEBSERVER_FRONTEND}

      # WEBSERVER_ACTIVITY
      WEBSERVER_ACTIVITY: ${WEBSERVER_ACTIVITY}
      PROMETHEUS_API_VERSION: ${WEBSERVER_PROMETHEUS_API_VERSION} # seems to be not used
      PROMETHEUS_URL: ${WEBSERVER_PROMETHEUS_URL}

      WEBSERVER_CATALOG: ${WEBSERVER_CATALOG}
      CATALOG_HOST: ${CATALOG_HOST}
      CATALOG_PORT: ${CATALOG_PORT}

      # WEBSERVER_DB
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_ENDPOINT: ${POSTGRES_ENDPOINT}
      POSTGRES_HOST: ${POSTGRES_HOST}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_PORT: ${POSTGRES_PORT}
      POSTGRES_USER: ${POSTGRES_USER}

      # WEBSERVER_DIAGNOSTICS
      WEBSERVER_DIAGNOSTICS: ${WEBSERVER_DIAGNOSTICS}
      DIAGNOSTICS_MAX_AVG_LATENCY: ${DIAGNOSTICS_MAX_AVG_LATENCY}
      DIAGNOSTICS_MAX_TASK_DELAY: ${DIAGNOSTICS_MAX_TASK_DELAY}
      DIAGNOSTICS_SLOW_DURATION_SECS: ${DIAGNOSTICS_SLOW_DURATION_SECS}

      # WEBSERVER_DIRECTOR_V2
      DIRECTOR_V2_HOST: ${DIRECTOR_V2_HOST}
      DIRECTOR_V2_PORT: ${DIRECTOR_V2_PORT}

      # WEBSERVER_DIRECTOR
      DIRECTOR_HOST: ${DIRECTOR_HOST}
      DIRECTOR_PORT: ${DIRECTOR_PORT}

      # WEBSERVER_EMAIL
      WEBSERVER_EMAIL: ${WEBSERVER_EMAIL}
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}

      WEBSERVER_EXPORTER: ${WEBSERVER_EXPORTER}

      # WEBSERVER_GARBAGE_COLLECTOR
      WEBSERVER_GARBAGE_COLLECTOR: ${WEBSERVER_GARBAGE_COLLECTOR}

      # WEBSERVER_INVITATIONS
      INVITATIONS_HOST: ${INVITATIONS_HOST}
      INVITATIONS_LOGLEVEL: ${INVITATIONS_LOGLEVEL}
      INVITATIONS_OSPARC_URL: ${INVITATIONS_OSPARC_URL}
      INVITATIONS_PASSWORD: ${INVITATIONS_PASSWORD}
      INVITATIONS_PORT: ${INVITATIONS_PORT}
      INVITATIONS_SECRET_KEY: ${INVITATIONS_SECRET_KEY}
      INVITATIONS_USERNAME: ${INVITATIONS_USERNAME}

      WEBSERVER_LOGIN: ${WEBSERVER_LOGIN}
      LOGIN_REGISTRATION_CONFIRMATION_REQUIRED: ${LOGIN_REGISTRATION_CONFIRMATION_REQUIRED}
      LOGIN_REGISTRATION_INVITATION_REQUIRED: ${LOGIN_REGISTRATION_INVITATION_REQUIRED}
      LOGIN_2FA_REQUIRED: ${LOGIN_2FA_REQUIRED}
      LOGIN_2FA_CODE_EXPIRATION_SEC: ${LOGIN_2FA_CODE_EXPIRATION_SEC}
      TWILIO_ACCOUNT_SID: ${TWILIO_ACCOUNT_SID}
      TWILIO_AUTH_TOKEN: ${TWILIO_AUTH_TOKEN}
      TWILIO_COUNTRY_CODES_W_ALPHANUMERIC_SID_SUPPORT: ${TWILIO_COUNTRY_CODES_W_ALPHANUMERIC_SID_SUPPORT}

      # WEBSERVER_REDIS
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}

      # WEBSERVER_REST
      REST_SWAGGER_API_DOC_ENABLED: ${REST_SWAGGER_API_DOC_ENABLED}

      # WEBSERVER_RESOURCE_MANAGER
      RESOURCE_MANAGER_RESOURCE_TTL_S: ${RESOURCE_MANAGER_RESOURCE_TTL_S}

      # WEBSERVER_RESOURCE_USAGE_TRACKER
      RESOURCE_USAGE_TRACKER_HOST: ${RESOURCE_USAGE_TRACKER_HOST}

      # WEBSERVER_SCICRUNCH
      WEBSERVER_SCICRUNCH: ${WEBSERVER_SCICRUNCH}
      SCICRUNCH_API_BASE_URL: ${SCICRUNCH_API_BASE_URL}
      SCICRUNCH_API_KEY: ${SCICRUNCH_API_KEY}

      # WEBSERVER_SESSION
      SESSION_SECRET_KEY: ${WEBSERVER_SESSION_SECRET_KEY}

      WEBSERVER_STATICWEB: ${WEBSERVER_STATICWEB}

      # WEBSERVER_STORAGE
      STORAGE_ENDPOINT: ${STORAGE_ENDPOINT}
      STORAGE_HOST: ${STORAGE_HOST}
      STORAGE_PORT: ${STORAGE_PORT}

      # WEBSERVER_STUDIES_DISPATCHER
      WEBSERVER_STUDIES_DISPATCHER: ${WEBSERVER_STUDIES_DISPATCHER}
      STUDIES_ACCESS_ANONYMOUS_ALLOWED: ${STUDIES_ACCESS_ANONYMOUS_ALLOWED}
      STUDIES_DEFAULT_SERVICE_THUMBNAIL: ${STUDIES_DEFAULT_SERVICE_THUMBNAIL}

      WEBSERVER_TRACING: ${WEBSERVER_TRACING}
      TRACING_ENABLED: ${TRACING_ENABLED}
      TRACING_ZIPKIN_ENDPOINT: ${TRACING_ZIPKIN_ENDPOINT}
      TRACING_THRIFT_COMPACT_ENDPOINT: ${TRACING_THRIFT_COMPACT_ENDPOINT}

      # WEBSERVER_PROJECTS
      WEBSERVER_PROJECTS: ${WEBSERVER_PROJECTS}
      PROJECTS_MAX_COPY_SIZE_BYTES: ${PROJECTS_MAX_COPY_SIZE_BYTES}
      PROJECTS_MAX_NUM_RUNNING_DYNAMIC_NODES: ${PROJECTS_MAX_NUM_RUNNING_DYNAMIC_NODES}

      # WEBSERVER_RABBITMQ
      RABBIT_HOST: ${RABBIT_HOST}
      RABBIT_PASSWORD: ${RABBIT_PASSWORD}
      RABBIT_PORT: ${RABBIT_PORT}
      RABBIT_SECURE: ${RABBIT_SECURE}
      RABBIT_USER: ${RABBIT_USER}

      # ARBITRARY ENV VARS

      # see [https://docs.gunicorn.org/en/stable/settings.html#timeout],
      # since we have the docker healthcheck already, this should be ok
      GUNICORN_CMD_ARGS: ${WEBSERVER_GUNICORN_CMD_ARGS}
      WEBSERVER_DB_LISTENER: ${WEBSERVER_DB_LISTENER}
      WEBSERVER_ANNOUNCEMENTS: ${WEBSERVER_ANNOUNCEMENTS}
      WEBSERVER_NOTIFICATIONS: ${WEBSERVER_NOTIFICATIONS}
      WEBSERVER_CLUSTERS: ${WEBSERVER_CLUSTERS}
      WEBSERVER_GROUPS: ${WEBSERVER_GROUPS}
      WEBSERVER_META_MODELING: ${WEBSERVER_META_MODELING}
      WEBSERVER_PRODUCTS: ${WEBSERVER_PRODUCTS}
      WEBSERVER_PUBLICATIONS: ${WEBSERVER_PUBLICATIONS}
      WEBSERVER_SOCKETIO: ${WEBSERVER_SOCKETIO}
      WEBSERVER_TAGS: ${WEBSERVER_TAGS}
      WEBSERVER_USERS: ${WEBSERVER_USERS}
      WEBSERVER_VERSION_CONTROL: ${WEBSERVER_VERSION_CONTROL}

    deploy:
      labels:
        - io.simcore.zone=${TRAEFIK_SIMCORE_ZONE}
        # gzip compression
        - traefik.http.middlewares.${SWARM_STACK_NAME}_gzip.compress=true
        # ssl header necessary so that socket.io upgrades correctly from polling to websocket mode. the middleware must be attached to the right connection.
        - traefik.http.middlewares.${SWARM_STACK_NAME_NO_HYPHEN}_sslheader.headers.customrequestheaders.X-Forwarded-Proto=http
        - traefik.enable=true
        - traefik.http.services.${SWARM_STACK_NAME}_webserver.loadbalancer.server.port=8080
        - traefik.http.services.${SWARM_STACK_NAME}_webserver.loadbalancer.healthcheck.path=/v0/
        - traefik.http.services.${SWARM_STACK_NAME}_webserver.loadbalancer.healthcheck.interval=2000ms
        - traefik.http.services.${SWARM_STACK_NAME}_webserver.loadbalancer.healthcheck.timeout=1000ms
        # NOTE: stickyness must remain until the long running tasks in the webserver are removed
        # and also https://github.com/ITISFoundation/osparc-simcore/pull/4180 is resolved.
        - traefik.http.services.${SWARM_STACK_NAME}_webserver.loadbalancer.sticky.cookie=true
        - traefik.http.services.${SWARM_STACK_NAME}_webserver.loadbalancer.sticky.cookie.samesite=lax
        - traefik.http.services.${SWARM_STACK_NAME}_webserver.loadbalancer.sticky.cookie.httponly=true
        - traefik.http.services.${SWARM_STACK_NAME}_webserver.loadbalancer.sticky.cookie.secure=true
        - traefik.http.middlewares.${SWARM_STACK_NAME}_webserver_retry.retry.attempts=2
        - traefik.http.routers.${SWARM_STACK_NAME}_webserver.service=${SWARM_STACK_NAME}_webserver
        - traefik.http.routers.${SWARM_STACK_NAME}_webserver.rule=hostregexp(`{host:.+}`) && (Path(`/`, `/v0`,`/socket.io/`,`/static-frontend-data.json`, `/study/{study_uuid:\b[0-9a-f]{8}\b-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-\b[0-9a-f]{12}\b}`, `/view`, `/#/view`, `/#/error`) ||  PathPrefix(`/v0/`))
        - traefik.http.routers.${SWARM_STACK_NAME}_webserver.entrypoints=http
        - traefik.http.routers.${SWARM_STACK_NAME}_webserver.priority=2
        - traefik.http.routers.${SWARM_STACK_NAME}_webserver.middlewares=${SWARM_STACK_NAME}_gzip@docker, ${SWARM_STACK_NAME_NO_HYPHEN}_sslheader@docker, ${SWARM_STACK_NAME}_webserver_retry
    networks:
      - default
      - interactive_services_subnet

  wb-db-event-listener:
    image: ${DOCKER_REGISTRY:-itisfoundation}/webserver:${DOCKER_IMAGE_TAG:-latest}
    init: true
    hostname: "{{.Node.Hostname}}-{{.Service.Name}}-{{.Task.Slot}}"
    environment:
      WEBSERVER_LOGLEVEL: ${WB_DB_EL_LOGLEVEL}

      WEBSERVER_HOST: ${WEBSERVER_HOST}

      # WEBSERVER_DB
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_ENDPOINT: ${POSTGRES_ENDPOINT}
      POSTGRES_HOST: ${POSTGRES_HOST}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_PORT: ${POSTGRES_PORT}
      POSTGRES_USER: ${POSTGRES_USER}

      DIRECTOR_HOST: ${DIRECTOR_HOST}
      DIRECTOR_PORT: ${DIRECTOR_PORT}

      DIRECTOR_V2_HOST: ${DIRECTOR_V2_HOST}
      DIRECTOR_V2_PORT: ${DIRECTOR_V2_PORT}

      REST_SWAGGER_API_DOC_ENABLED: ${REST_SWAGGER_API_DOC_ENABLED}

      # WEBSERVER_RESOURCE_USAGE_TRACKER
      RESOURCE_USAGE_TRACKER_HOST: ${RESOURCE_USAGE_TRACKER_HOST}

      # WEBSERVER_INVITATIONS
      INVITATIONS_HOST: ${INVITATIONS_HOST}
      INVITATIONS_LOGLEVEL: ${INVITATIONS_LOGLEVEL}
      INVITATIONS_OSPARC_URL: ${INVITATIONS_OSPARC_URL}
      INVITATIONS_PASSWORD: ${INVITATIONS_PASSWORD}
      INVITATIONS_PORT: ${INVITATIONS_PORT}
      INVITATIONS_SECRET_KEY: ${INVITATIONS_SECRET_KEY}
      INVITATIONS_USERNAME: ${INVITATIONS_USERNAME}

      GUNICORN_CMD_ARGS: ${WEBSERVER_GUNICORN_CMD_ARGS}
      LOG_FORMAT_LOCAL_DEV_ENABLED: ${LOG_FORMAT_LOCAL_DEV_ENABLED}
      SWARM_STACK_NAME: ${SWARM_STACK_NAME}
      WEBSERVER_DB_LISTENER: ${WB_DB_EL_DB_LISTENER}
      WEBSERVER_SOCKETIO: ${WB_DB_EL_SOCKETIO}
      WEBSERVER_ANNOUNCEMENTS: ${WB_DB_EL_ANNOUNCEMENTS}
      WEBSERVER_ACTIVITY: ${WB_DB_EL_ACTIVITY}
      WEBSERVER_CATALOG: ${WB_DB_EL_CATALOG}
      WEBSERVER_NOTIFICATIONS: ${WB_DB_EL_NOTIFICATIONS}
      WEBSERVER_DIAGNOSTICS: ${WB_DB_EL_DIAGNOSTICS}
      WEBSERVER_EMAIL: ${WB_DB_EL_EMAIL}
      WEBSERVER_EXPORTER: ${WB_DB_EL_EXPORTER}
      WEBSERVER_FRONTEND: ${WB_DB_EL_FRONTEND}
      WEBSERVER_GARBAGE_COLLECTOR: ${WB_DB_EL_GARBAGE_COLLECTOR}
      WEBSERVER_LOGIN: ${WB_DB_EL_LOGIN}
      WEBSERVER_PROJECTS: ${WB_DB_EL_PROJECTS}
      WEBSERVER_SCICRUNCH: ${WB_DB_EL_SCICRUNCH}
      WEBSERVER_STATICWEB: ${WB_DB_EL_STATICWEB}
      WEBSERVER_STORAGE: ${WB_DB_EL_STORAGE}
      WEBSERVER_STUDIES_DISPATCHER: ${WB_DB_EL_STUDIES_DISPATCHER}
      WEBSERVER_TRACING: ${WB_DB_EL_TRACING}
      WEBSERVER_CLUSTERS: ${WB_DB_EL_CLUSTERS}
      WEBSERVER_GROUPS: ${WB_DB_EL_GROUPS}
      WEBSERVER_META_MODELING: ${WB_DB_EL_META_MODELING}
      WEBSERVER_PRODUCTS: ${WB_DB_EL_PRODUCTS}
      WEBSERVER_PUBLICATIONS: ${WB_DB_EL_PUBLICATIONS}
      WEBSERVER_TAGS: ${WB_DB_EL_TAGS}
      WEBSERVER_USERS: ${WB_DB_EL_USERS}
      WEBSERVER_VERSION_CONTROL: ${WB_DB_EL_VERSION_CONTROL}
      SESSION_SECRET_KEY: ${WEBSERVER_SESSION_SECRET_KEY}

      # WEBSERVER_RABBITMQ
      RABBIT_HOST: ${RABBIT_HOST}
      RABBIT_PASSWORD: ${RABBIT_PASSWORD}
      RABBIT_PORT: ${RABBIT_PORT}
      RABBIT_SECURE: ${RABBIT_SECURE}
      RABBIT_USER: ${RABBIT_USER}

      # WEBSERVER_REDIS
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}

      RESOURCE_MANAGER_RESOURCE_TTL_S: ${RESOURCE_MANAGER_RESOURCE_TTL_S}

    deploy:
      # NOTE: https://github.com/ITISFoundation/osparc-simcore/pull/4286
      # NOTE: this MUSTN'T change, or weird things might happen
      # this will stay until all legacy dynamic services are gone.
      replicas: 1
    networks:
      - default

  wb-garbage-collector:
    image: ${DOCKER_REGISTRY:-itisfoundation}/webserver:${DOCKER_IMAGE_TAG:-latest}
    init: true
    hostname: "{{.Node.Hostname}}-{{.Service.Name}}-{{.Task.Slot}}"
    environment:
      WEBSERVER_LOGLEVEL: ${WB_GC_LOGLEVEL}

      WEBSERVER_HOST: ${WEBSERVER_HOST}

      # WEBSERVER_RESOURCE_USAGE_TRACKER
      RESOURCE_USAGE_TRACKER_HOST: ${RESOURCE_USAGE_TRACKER_HOST}

      REST_SWAGGER_API_DOC_ENABLED: ${REST_SWAGGER_API_DOC_ENABLED}

      INVITATIONS_HOST: ${INVITATIONS_HOST}
      INVITATIONS_LOGLEVEL: ${INVITATIONS_LOGLEVEL}
      INVITATIONS_OSPARC_URL: ${INVITATIONS_OSPARC_URL}
      INVITATIONS_PASSWORD: ${INVITATIONS_PASSWORD}
      INVITATIONS_PORT: ${INVITATIONS_PORT}
      INVITATIONS_SECRET_KEY: ${INVITATIONS_SECRET_KEY}
      INVITATIONS_USERNAME: ${INVITATIONS_USERNAME}

      # WEBSERVER_DB
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_ENDPOINT: ${POSTGRES_ENDPOINT}
      POSTGRES_HOST: ${POSTGRES_HOST}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_PORT: ${POSTGRES_PORT}
      POSTGRES_USER: ${POSTGRES_USER}

      DIRECTOR_HOST: ${DIRECTOR_HOST}
      DIRECTOR_PORT: ${DIRECTOR_PORT}

      DIRECTOR_V2_HOST: ${DIRECTOR_V2_HOST}
      DIRECTOR_V2_PORT: ${DIRECTOR_V2_PORT}

      GUNICORN_CMD_ARGS: ${WEBSERVER_GUNICORN_CMD_ARGS}

      LOG_FORMAT_LOCAL_DEV_ENABLED: ${LOG_FORMAT_LOCAL_DEV_ENABLED}

      STORAGE_HOST: ${STORAGE_HOST}
      STORAGE_PORT: ${STORAGE_PORT}

      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}

      SWARM_STACK_NAME: ${SWARM_STACK_NAME}

      WEBSERVER_DB_LISTENER: ${WB_GC_DB_LISTENER}

      WEBSERVER_GARBAGE_COLLECTOR: ${WB_GC_GARBAGE_COLLECTOR}

      RESOURCE_MANAGER_RESOURCE_TTL_S: ${WB_GC_RESOURCE_MANAGER_RESOURCE_TTL_S}

      WEBSERVER_ANNOUNCEMENTS: ${WB_GC_ANNOUNCEMENTS}
      WEBSERVER_ACTIVITY: ${WB_GC_ACTIVITY}
      WEBSERVER_CATALOG: ${WB_GC_CATALOG}
      WEBSERVER_NOTIFICATIONS: ${WB_GC_NOTIFICATIONS}
      WEBSERVER_DIAGNOSTICS: ${WB_GC_DIAGNOSTICS}
      WEBSERVER_EMAIL: ${WB_GC_EMAIL}
      WEBSERVER_EXPORTER: ${WB_GC_EXPORTER}
      WEBSERVER_FRONTEND: ${WB_GC_FRONTEND}
      WEBSERVER_LOGIN: ${WB_GC_LOGIN}
      WEBSERVER_PROJECTS: ${WB_GC_PROJECTS}
      WEBSERVER_SCICRUNCH: ${WB_GC_SCICRUNCH}
      WEBSERVER_STATICWEB: ${WB_GC_STATICWEB}
      WEBSERVER_STUDIES_DISPATCHER: ${WB_GC_STUDIES_DISPATCHER}
      WEBSERVER_TRACING: ${WB_GC_TRACING}
      WEBSERVER_CLUSTERS: ${WB_GC_CLUSTERS}
      WEBSERVER_GROUPS: ${WB_GC_GROUPS}
      WEBSERVER_META_MODELING: ${WB_GC_META_MODELING}
      WEBSERVER_PRODUCTS: ${WB_GC_PRODUCTS}
      WEBSERVER_PUBLICATIONS: ${WB_GC_PUBLICATIONS}
      WEBSERVER_SOCKETIO: ${WB_GC_SOCKETIO}
      WEBSERVER_TAGS: ${WB_GC_TAGS}
      WEBSERVER_USERS: ${WB_GC_USERS}
      WEBSERVER_VERSION_CONTROL: ${WB_GC_VERSION_CONTROL}
      SESSION_SECRET_KEY: ${WEBSERVER_SESSION_SECRET_KEY}

      # WEBSERVER_RABBITMQ
      RABBIT_HOST: ${RABBIT_HOST}
      RABBIT_PASSWORD: ${RABBIT_PASSWORD}
      RABBIT_PORT: ${RABBIT_PORT}
      RABBIT_SECURE: ${RABBIT_SECURE}
      RABBIT_USER: ${RABBIT_USER}
    networks:
      - default
      - interactive_services_subnet

  agent:
    image: ${DOCKER_REGISTRY:-itisfoundation}/agent:${DOCKER_IMAGE_TAG:-latest}
    init: true
    hostname: "{{.Node.Hostname}}-{{.Service.Name}}"
    deploy:
      mode: global
      resources:
        limits:
          cpus: "1.0"
          memory: 1024M

    networks:
      - default
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      LOGLEVEL: ${LOG_LEVEL:-INFO}
      LOG_FORMAT_LOCAL_DEV_ENABLED: ${LOG_FORMAT_LOCAL_DEV_ENABLED}
      AGENT_VOLUMES_CLEANUP_S3_SECURE: ${AGENT_VOLUMES_CLEANUP_S3_SECURE}
      AGENT_VOLUMES_CLEANUP_S3_ENDPOINT: ${AGENT_VOLUMES_CLEANUP_S3_ENDPOINT}
      AGENT_VOLUMES_CLEANUP_S3_ACCESS_KEY: ${AGENT_VOLUMES_CLEANUP_S3_ACCESS_KEY}
      AGENT_VOLUMES_CLEANUP_S3_SECRET_KEY: ${AGENT_VOLUMES_CLEANUP_S3_SECRET_KEY}
      AGENT_VOLUMES_CLEANUP_S3_BUCKET: ${AGENT_VOLUMES_CLEANUP_S3_BUCKET}
      AGENT_VOLUMES_CLEANUP_S3_PROVIDER: ${AGENT_VOLUMES_CLEANUP_S3_PROVIDER}
      AGENT_VOLUMES_CLEANUP_S3_REGION: ${AGENT_VOLUMES_CLEANUP_S3_REGION:-us-east-1}

  dask-sidecar:
    image: ${DOCKER_REGISTRY:-itisfoundation}/dask-sidecar:${DOCKER_IMAGE_TAG:-latest}
    init: true
    hostname: "{{.Node.Hostname}}-{{.Service.Name}}"
    deploy:
      mode: global
      endpoint_mode: dnsrr
      resources:
        reservations:
          cpus: "0.10"
          memory: "100M"
    volumes:
      - computational_shared_data:${SIDECAR_COMP_SERVICES_SHARED_FOLDER:-/home/scu/computational_shared_data}
      - /var/run/docker.sock:/var/run/docker.sock
    environment: &sidecar-environment
      DASK_SCHEDULER_HOST: ${DASK_SCHEDULER_HOST:-dask-scheduler}
      DASK_LOG_FORMAT_LOCAL_DEV_ENABLED: ${LOG_FORMAT_LOCAL_DEV_ENABLED}
      SIDECAR_LOGLEVEL: ${LOG_LEVEL:-WARNING}
      SIDECAR_COMP_SERVICES_SHARED_VOLUME_NAME: ${SWARM_STACK_NAME}_computational_shared_data
      SIDECAR_COMP_SERVICES_SHARED_FOLDER: ${SIDECAR_COMP_SERVICES_SHARED_FOLDER:-/home/scu/computational_shared_data}
    networks:
      - computational_services_subnet

  dask-scheduler:
    image: ${DOCKER_REGISTRY:-itisfoundation}/dask-sidecar:${DOCKER_IMAGE_TAG:-latest}
    init: true
    hostname: "{{.Node.Hostname}}-{{.Service.Name}}-{{.Task.Slot}}"
    environment:
      <<: *sidecar-environment
      DASK_START_AS_SCHEDULER: 1

    networks:
      - computational_services_subnet

  datcore-adapter:
    image: ${DOCKER_REGISTRY:-itisfoundation}/datcore-adapter:${DOCKER_IMAGE_TAG:-latest}
    init: true
    hostname: "{{.Node.Hostname}}-{{.Service.Name}}-{{.Task.Slot}}"
    networks:
      - storage_subnet
    environment:
      - TRACING_THRIFT_COMPACT_ENDPOINT=${TRACING_THRIFT_COMPACT_ENDPOINT}
      - DATCORE_ADAPTER_LOG_FORMAT_LOCAL_DEV_ENABLED=${LOG_FORMAT_LOCAL_DEV_ENABLED}

  storage:
    image: ${DOCKER_REGISTRY:-itisfoundation}/storage:${DOCKER_IMAGE_TAG:-latest}
    init: true
    hostname: "{{.Node.Hostname}}-{{.Service.Name}}-{{.Task.Slot}}"
    environment:
      - BF_API_KEY=${BF_API_KEY}
      - BF_API_SECRET=${BF_API_SECRET}
      - DATCORE_ADAPTER_HOST=${DATCORE_ADAPTER_HOST:-datcore-adapter}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_ENDPOINT=${POSTGRES_ENDPOINT}
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_PORT=${POSTGRES_PORT}
      - POSTGRES_USER=${POSTGRES_USER}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME}
      - S3_ENDPOINT=${S3_ENDPOINT}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
      - S3_SECURE=${S3_SECURE}
      - STORAGE_LOGLEVEL=${LOG_LEVEL:-WARNING}
      - STORAGE_MONITORING_ENABLED=1
      - TRACING_ZIPKIN_ENDPOINT=${TRACING_ZIPKIN_ENDPOINT:-http://jaeger:9411}
    networks:
      - default
      - interactive_services_subnet
      - storage_subnet

  rabbit:
    image: itisfoundation/rabbitmq:3.11.2-management
    init: true
    hostname: "{{.Node.Hostname}}-{{.Service.Name}}-{{.Task.Slot}}"
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBIT_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBIT_PASSWORD}
    volumes:
      - rabbit_data:/var/lib/rabbitmq
    networks:
      - default
      - interactive_services_subnet
      - autoscaling_subnet
    healthcheck:
      # see https://www.rabbitmq.com/monitoring.html#individual-checks for info about health-checks available in rabbitmq
      test: rabbitmq-diagnostics -q status
      interval: 5s
      timeout: 30s
      retries: 5
      start_period: 5s

  migration:
    image: ${DOCKER_REGISTRY:-itisfoundation}/migration:${DOCKER_IMAGE_TAG:-latest}
    init: true
    hostname: "{{.Node.Hostname}}-{{.Service.Name}}-{{.Task.Slot}}"
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_ENDPOINT=${POSTGRES_ENDPOINT}
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_PORT=${POSTGRES_PORT}
      - POSTGRES_USER=${POSTGRES_USER}
    networks:
      - default # actually needed for the postgres service only

  postgres:
    image: "postgres:14.8-alpine@sha256:150dd39ccb7ae6c7ba6130c3582c39a30bb5d3d22cb08ad0ba37001e3f829abc"
    init: true
    hostname: "{{.Node.Hostname}}-{{.Service.Name}}-{{.Task.Slot}}"
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_USER=${POSTGRES_USER}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - type: tmpfs
        target: /dev/shm
        tmpfs:
          size: 16000000000
    networks:
      - default
      - interactive_services_subnet
    healthcheck:
      test:
        [
          "CMD",
          "pg_isready",
          "--username",
          "${POSTGRES_USER}",
          "--dbname",
          "${POSTGRES_DB}"
        ]
      interval: 5s
      retries: 5
    # NOTES: this is not yet compatible with portainer deployment but could work also for other containers
    # works with Docker 19.03 and not yet with Portainer 1.23.0 (see https://github.com/portainer/portainer/issues/3551)
    # in the meantime postgres allows to set a configuration through CLI.
    # sysctls:
    #   # NOTES: these values are needed here because docker swarm kills long running idle
    #   # connections by default after 15 minutes see https://github.com/moby/moby/issues/31208
    #   # info about these values are here https://tldp.org/HOWTO/TCP-Keepalive-HOWTO/usingkeepalive.html
    #   - net.ipv4.tcp_keepalive_intvl=600
    #   - net.ipv4.tcp_keepalive_probes=9
    #   - net.ipv4.tcp_keepalive_time=600
    command:
      [
        "postgres",
        "-c",
        "tcp_keepalives_idle=600",
        "-c",
        "tcp_keepalives_interval=600",
        "-c",
        "tcp_keepalives_count=5",
        "-c",
        "max_connections=413",
        "-c",
        "shared_buffers=256MB"
      ]

  redis:
    image: "redis:6.2.6@sha256:4bed291aa5efb9f0d77b76ff7d4ab71eee410962965d052552db1fb80576431d"
    init: true
    hostname: "{{.Node.Hostname}}-{{.Service.Name}}-{{.Task.Slot}}"
    command:
      # redis server will write a backup every 60 seconds if at least 1 key was changed
      # also aof (append only) is also enabled such that we get full durability at the expense
      # of backup size. The backup is written into /data.
      # https://redis.io/topics/persistence
      [
        "redis-server",
        "--save",
        "60 1",
        "--loglevel",
        "verbose",
        "--databases",
        "6",
        "--appendonly",
        "yes"
      ]
    networks:
      - default
      - autoscaling_subnet
    volumes:
      - redis-data:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 5s
      timeout: 30s
      retries: 50

  traefik:
    image: "traefik:v2.9.8@sha256:553239e27c4614d0477651415205b9b119f7a98f698e6562ef383c9d8ff3b6e6"
    init: true
    hostname: "{{.Node.Hostname}}-{{.Service.Name}}-{{.Task.Slot}}"
    command:
      - "--api=true"
      - "--api.dashboard=true"
      - "--ping=true"
      - "--entryPoints.ping.address=:9082"
      - "--ping.entryPoint=ping"
      - "--log.level=WARNING"
      - "--accesslog=false"
      - "--metrics.prometheus=true"
      - "--metrics.prometheus.addEntryPointsLabels=true"
      - "--metrics.prometheus.addServicesLabels=true"
      - "--entryPoints.metrics.address=:8082"
      - "--metrics.prometheus.entryPoint=metrics"
      - "--entryPoints.http.address=:80"
      - "--entryPoints.http.forwardedHeaders.insecure"
      - "--entryPoints.simcore_api.address=:10081"
      - "--entryPoints.simcore_api.forwardedHeaders.insecure"
      - "--entryPoints.traefik_monitor.address=:8080"
      - "--entryPoints.traefik_monitor.forwardedHeaders.insecure"
      - "--providers.docker.endpoint=unix:///var/run/docker.sock"
      - "--providers.docker.network=${SWARM_STACK_NAME}_default"
      - "--providers.docker.swarmMode=true"
      # https://github.com/traefik/traefik/issues/7886
      - "--providers.docker.swarmModeRefreshSeconds=1"
      - "--providers.docker.exposedByDefault=false"
      - "--providers.docker.constraints=Label(`io.simcore.zone`, `${TRAEFIK_SIMCORE_ZONE}`)"
      - "--tracing=true"
      - "--tracing.jaeger=true"
      - "--tracing.jaeger.samplingServerURL=http://jaeger:5778/sampling"
      - "--tracing.jaeger.localAgentHostPort=jaeger:6831"
    volumes:
      # So that Traefik can listen to the Docker events
      - /var/run/docker.sock:/var/run/docker.sock
    deploy:
      placement:
        constraints:
          - node.role == manager
      labels:
        # for each service in the stack a new middlaware for rate limiting needs to be registered here
        # requests = average / period this is how the limits are defined
        - traefik.http.middlewares.ratelimit-${SWARM_STACK_NAME}_api-server.ratelimit.average=1
        - traefik.http.middlewares.ratelimit-${SWARM_STACK_NAME}_api-server.ratelimit.period=1m
        # a burst is computed over a period of 1 second
        - traefik.http.middlewares.ratelimit-${SWARM_STACK_NAME}_api-server.ratelimit.burst=10
        # X-Forwarded-For header extracts second IP from the right, count starts at one
        - traefik.http.middlewares.ratelimit-${SWARM_STACK_NAME}_api-server.ratelimit.sourcecriterion.ipstrategy.depth=2
    networks:
      - default
      - interactive_services_subnet # for legacy dynamic services
    #healthcheck:
    #  test: wget --quiet --tries=1 --spider http://localhost:9082/ping || exit 1
    #  interval: 3s
    #  timeout: 1s
    #  retries: 3
    #  start_period: 20s


volumes:
  postgres_data:
    name: ${SWARM_STACK_NAME}_postgres_data
  computational_shared_data:
    name: ${SWARM_STACK_NAME}_computational_shared_data
  redis-data:
    name: ${SWARM_STACK_NAME}_redis-data
  rabbit_data:
    name: ${SWARM_STACK_NAME}_rabbit_data

networks:
  default:
    attachable: true
    name: ${SWARM_STACK_NAME}_default
  storage_subnet:
    attachable: true
    name: ${SWARM_STACK_NAME}_storage_subnet
  autoscaling_subnet:
    attachable: true
    name: ${SWARM_STACK_NAME}_autoscaling_subnet
  interactive_services_subnet:
    name: ${SWARM_STACK_NAME}_interactive_services_subnet
    driver: overlay
    attachable: true
    internal: false
    labels:
      com.simcore.description: "interactive services network"
    ipam:
      driver: default
      config:
        - subnet: "172.8.0.0/16"
  computational_services_subnet:
    name: ${SWARM_STACK_NAME}_computational_services_subnet
    driver: overlay
    attachable: true
    internal: false
    labels:
      com.simcore.description: "computational services network"
