#
# docker-compose to build services
#
# set BUILD_TARGET as `production` or `development`
#
version: '3.7'
services:

  apihub:
    image: ${DOCKER_REGISTRY:-itisfoundation}/apihub:${DOCKER_IMAGE_TAG:-latest}
    build:
      context: ../
      dockerfile: services/apihub/Dockerfile
      cache_from:
        - ${DOCKER_REGISTRY:-itisfoundation}/apihub:cache
        - ${DOCKER_REGISTRY:-itisfoundation}/apihub:${DOCKER_IMAGE_TAG:-latest}
      target: ${BUILD_TARGET:-production}
      labels:
        org.label-schema.schema-version: "1.0"
        org.label-schema.build-date: "${BUILD_DATE}"
        org.label-schema.vcs-url: "https://github.com/ITISFoundation/osparc-simcore"
        org.label-schema.vcs-ref: "${VCS_REF}"

  director:
    image: ${DOCKER_REGISTRY:-itisfoundation}/director:${DOCKER_IMAGE_TAG:-latest}
    build:
      context: ../
      dockerfile: services/director/Dockerfile
      cache_from:
        - ${DOCKER_REGISTRY:-itisfoundation}/director:cache
        - ${DOCKER_REGISTRY:-itisfoundation}/director:${DOCKER_IMAGE_TAG:-latest}
      target: ${BUILD_TARGET:-production}
      labels:
        org.label-schema.schema-version: "1.0"
        org.label-schema.build-date: "${BUILD_DATE}"
        org.label-schema.vcs-url: "https://github.com/ITISFoundation/osparc-simcore"
        org.label-schema.vcs-ref: "${VCS_REF}"

  webserver:
    image: ${DOCKER_REGISTRY:-itisfoundation}/webserver:${DOCKER_IMAGE_TAG:-latest}
    build:
      context: ../
      dockerfile: services/web/Dockerfile
      cache_from:
        - ${DOCKER_REGISTRY:-itisfoundation}/webserver:cache
        - ${DOCKER_REGISTRY:-itisfoundation}/webserver:${DOCKER_IMAGE_TAG:-latest}
      target: ${BUILD_TARGET:-production}
      labels:
        org.label-schema.schema-version: "1.0"
        org.label-schema.build-date: "${BUILD_DATE}"
        org.label-schema.vcs-url: "https://github.com/ITISFoundation/osparc-simcore"
        org.label-schema.vcs-ref: "${VCS_REF}"

  sidecar:
    image: ${DOCKER_REGISTRY:-itisfoundation}/sidecar:${DOCKER_IMAGE_TAG:-latest}
    build:
      context: ../
      dockerfile: services/sidecar/Dockerfile
      cache_from:
        - ${DOCKER_REGISTRY:-itisfoundation}/sidecar:cache
        - ${DOCKER_REGISTRY:-itisfoundation}/sidecar:${DOCKER_IMAGE_TAG:-latest}
      target: ${BUILD_TARGET:-production}
      labels:
        org.label-schema.schema-version: "1.0"
        org.label-schema.build-date: "${BUILD_DATE}"
        org.label-schema.vcs-url: "https://github.com/ITISFoundation/osparc-simcore"
        org.label-schema.vcs-ref: "${VCS_REF}"

  storage:
    image: ${DOCKER_REGISTRY:-itisfoundation}/storage:${DOCKER_IMAGE_TAG:-latest}
    build:
      context: ../
      dockerfile: services/storage/Dockerfile
      cache_from:
        - ${DOCKER_REGISTRY:-itisfoundation}/storage:cache
        - ${DOCKER_REGISTRY:-itisfoundation}/storage:${DOCKER_IMAGE_TAG:-latest}
      target: ${BUILD_TARGET:-production}
      labels:
        org.label-schema.schema-version: "1.0"
        org.label-schema.build-date: "${BUILD_DATE}"
        org.label-schema.vcs-url: "https://github.com/ITISFoundation/osparc-simcore"
        org.label-schema.vcs-ref: "${VCS_REF}"
