# USAGE:  docker-compose -f docker-compose.yml -f docker-compose.deploy.yml ...
# FIXME: add secrets in production?
# FIXME: remove explicit dns
version: '3.4'
services:
  apihub:
    image: services_apihub:dev
    deploy:
      placement:
       constraints:
          - node.platform.os == linux
  director:
    #image: masu.speag.com/simcore/workbench/director:2.3
    image: services_director:dev
    #dns:
    #  - 172.16.8.15
    deploy:
      placement:
       constraints:
          - node.platform.os == linux
          - node.role == manager
    environment:
      - POSTGRES_ENDPOINT=postgres:5432
      - POSTGRES_USER=simcore
      - POSTGRES_PASSWORD=simcore
      - POSTGRES_DB=simcoredb
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - RABBITMQ_USER=simcore
      - RABBITMQ_PASSWORD=simcore
      - RABBITMQ_PROGRESS_CHANNEL=comp.backend.channels.progress
      - RABBITMQ_LOG_CHANNEL=comp.backend.channels.log
      - S3_ENDPOINT=minio:9000
      - S3_ACCESS_KEY=12345678
      - S3_SECRET_KEY=12345678
      - S3_BUCKET_NAME=simcore
      - STORAGE_ENDPOINT=storage:8080
      - PUBLISHED_HOST_NAME=localhost
  webclient:
    image: services_webclient:dev
    deploy:
      placement:
        constraints:
          - node.platform.os == linux
  webserver:
    #image: masu.speag.com/simcore/workbench/webserver:2.3
    image: services_webserver:dev
    #dns:
    #  - 172.16.8.15
    deploy:
      placement:
        constraints:
          - node.platform.os == linux
    environment:
      - OSPARC_PUBLIC_URL=http://localhost:9081
      - POSTGRES_ENDPOINT=postgres:5432
      - POSTGRES_USER=simcore
      - POSTGRES_PASSWORD=simcore
      - POSTGRES_DB=simcoredb
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - RABBITMQ_USER=simcore
      - RABBITMQ_PASSWORD=simcore
      - RABBITMQ_PROGRESS_CHANNEL=comp.backend.channels.progress
      - RABBITMQ_LOG_CHANNEL=comp.backend.channels.log
      - S3_ENDPOINT=minio:9000
      - S3_ACCESS_KEY=12345678
      - S3_SECRET_KEY=12345678
      - S3_BUCKET_NAME=simcore
      - SMTP_HOST=mail.speag.com
      - SMTP_PORT=25

  storage:
    image: services_storage:dev
    deploy:
      placement:
        constraints:
          - node.platform.os == linux
    environment:
      - POSTGRES_ENDPOINT=postgres:5432
      - POSTGRES_USER=simcore
      - POSTGRES_PASSWORD=simcore
      - POSTGRES_DB=simcoredb
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - S3_ENDPOINT=minio:9000
      - S3_ACCESS_KEY=12345678
      - S3_SECRET_KEY=12345678
      - S3_BUCKET_NAME=simcore
      - BF_API_KEY=id_without_quotes
      - BF_API_SECRET=id_without_quotes
    depends_on:
      - minio
      - postgres
  rabbit:
    image: rabbitmq:3-management
    environment:
      - RABBITMQ_DEFAULT_USER=simcore
      - RABBITMQ_DEFAULT_PASS=simcore
  postgres:
    image: postgres:10
    environment:
      - POSTGRES_USER=simcore
      - POSTGRES_PASSWORD=simcore
      - POSTGRES_DB=simcoredb
  adminer:
    image: adminer
    depends_on:
      - postgres
  sidecar:
    image: services_sidecar:dev
    environment:
      - POSTGRES_ENDPOINT=postgres:5432
      - POSTGRES_USER=simcore
      - POSTGRES_PASSWORD=simcore
      - POSTGRES_DB=simcoredb
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - RABBITMQ_USER=simcore
      - RABBITMQ_PASSWORD=simcore
      - RABBITMQ_PROGRESS_CHANNEL=comp.backend.channels.progress
      - RABBITMQ_LOG_CHANNEL=comp.backend.channels.log
      - S3_ENDPOINT=minio:9000
      - S3_ACCESS_KEY=12345678
      - S3_SECRET_KEY=12345678
      - S3_BUCKET_NAME=simcore
      - STORAGE_ENDPOINT=storage:8080
  minio:
    environment:
      - MINIO_ACCESS_KEY=12345678
      - MINIO_SECRET_KEY=12345678
