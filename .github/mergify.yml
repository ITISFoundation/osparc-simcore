# NOTE: the PR is added to the queue when all checks have passed
# and the CI is fully grean and ready to be merged
queue_rules:
  - name: default
    queue_conditions:
      # general prerequisits fo accept the PR in the queue
      - label=-automerge # let Mergify know that the PR can be merged (added manually)
      - label!=-do-not-merge # block Mergify from merging the PR (added manually)
      - base=master
      - -draft # PR is not in draft state
      - -conflict # No merge conflicts

      # Check for required reviews
      - "#approved-reviews-by>=2" # Requires 2 approving reviews
      - "#changes-requested-reviews-by=0" # No changes requested
      - "#review-threads-unresolved=0" # All review threads resolved

    merge_conditions:
      # list of CI checks that need to pass
      - check-success=unit-tests
      - check-success=integration-tests
      - check-success=system-tests

# NOTE: these rules help you to forget about the PR
# and let mergify update it and deal with flaky tests
pull_request_rules:
  - name: update branch if behind master
    conditions:
      - label=-automerge
      - label!=-do-not-merge
      - base=master
    actions:
      update:

  - name: retry CI on fails (used for flaky tests)
    conditions:
      - label=-automerge
      - label!=-do-not-merge
      - base=master
      - or:
          - check-failure=unit-tests
          - check-failure=integration-tests
          - check-failure=system-tests
    actions:
      github_actions:
        workflow:
          dispatch:
            - workflow: .github/workflows/ci-testing-deploy.yml
