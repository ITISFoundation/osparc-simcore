name: Github-Action-CI

on:
  push: 

env:
  DOCKER_REGISTRY: ${{ secrets.DOCKER_REGISTRY }}


jobs:
  build-test-images:
    runs-on: ubuntu-18.04
    name: build docker test images
    steps:
    - uses: actions/checkout@v1
    - name: setup-docker
      uses: docker-practice/actions-setup-docker@0.0.1
    - name: setup docker-compose        
      run: sudo ./ci/github/helpers/setup_docker_compose.sh        
    - name: before install
      run: ./ci/github/build/test-images before_install
    - name: before script
      run: ./ci/github/build/test-images before_script
    - name: script
      run: |
        ./ci/github/build/test-images script
        ./ci/github/build/test-images after_success

  unit-test-webserver:
    name: Webserver unit-testing
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        python: [3.6, 3.7, 3.8]
        os: [ubuntu-18.04]
      fail-fast: false
    steps:
    - uses: actions/checkout@v1
    - name: setup-docker
      uses: docker-practice/actions-setup-docker@0.0.1
    - name: setup docker-compose
      run: sudo ./ci/github/helpers/setup_docker_compose.sh        
    - name: Setup Python environment
      uses: actions/setup-python@v1.1.1
      with:
        # Version range or exact version of a Python version to use, using semvers version range syntax.
        python-version: ${{ matrix.python }}
    - name: show system version
      run: ./ci/helpers/show_system_versions
    - name: setup pip
      run: ./ci/helpers/ensure_python_pip
    - name: install webserver
      run: pushd services/web/server; pip3 install -r requirements/ci.txt; popd;
    - name: test
      run: pytest --cov=simcore_service_webserver --cov-append -v -m "not travis" services/web/server/tests/unit
    
  unit-test-director:
    name: director unit-testing
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        python: [3.6, 3.7, 3.8]
        os: [ubuntu-18.04]
      fail-fast: false
    steps:
    - uses: actions/checkout@v1
    - name: setup-docker
      uses: docker-practice/actions-setup-docker@0.0.1
    - name: setup docker-compose
      run: sudo ./ci/github/helpers/setup_docker_compose.sh        
    - name: Setup Python environment
      uses: actions/setup-python@v1.1.1
      with:
        # Version range or exact version of a Python version to use, using semvers version range syntax.
        python-version: ${{ matrix.python }}
    - name: show system version
      run: ./ci/helpers/show_system_versions
    - name: setup pip
      run: ./ci/helpers/ensure_python_pip
    - name: install director
      run: pushd services/director; pip3 install -r requirements/ci.txt; popd;
    - name: test
      run: pytest --cov=simcore_service_director --cov-append -v -m "not travis" services/director/tests/unit
        
