dist: xenial
env:
  global:
    - DOCKER_COMPOSE_VERSION=1.23.2
services:
  - docker
addons:
  apt:
    packages:
      - docker-ce
      - expect-dev # for unbuffer: brings color back into travis logs

jobs:
  include:
    # build images ----------------------------------------------------------------------
    - stage: build
      name: build simcore images
      sudo: required
      before_install:
        - unbuffer sudo bash ops/travis/build/test-images.sh before_install
      install:
        - unbuffer bash ops/travis/build/test-images.sh install
      before_script:
        - unbuffer bash ops/travis/build/test-images.sh before_script
      script:
        - unbuffer bash ops/travis/build/test-images.sh script
      after_success:
        - unbuffer bash ops/travis/build/test-images.sh after_success
      after_failure:
        - unbuffer bash ops/travis/build/test-images.sh after_failure
      deploy:
        - provider: script
          skip_cleanup: true
          script: unbuffer bash ops/travis/deploy/test-images.sh
          on:
            all_branches: true

    # test python, webserver ----------------------------------------------------------------------
    - stage: unit testing
      name: webserver
      language: python
      python:
        - "3.6"
      sudo: required
      cache: pip
      before_install:
        - unbuffer sudo bash ops/travis/unit-testing/webserver.sh before_install
      install:
        - unbuffer bash ops/travis/unit-testing/webserver.sh install
      before_script:
        - unbuffer bash ops/travis/unit-testing/webserver.sh before_script
      script:
        - unbuffer bash ops/travis/unit-testing/webserver.sh script
      after_success:
        - unbuffer bash ops/travis/unit-testing/webserver.sh after_success
      after_failure:
        - unbuffer bash ops/travis/unit-testing/webserver.sh after_failure

    # test python, director ----------------------------------------------------------------------
    - stage: unit testing
      name: director
      language: python
      python:
        - "3.6"
      sudo: required
      cache: pip
      before_install:
        - unbuffer sudo bash ops/travis/unit-testing/director.sh before_install
      install:
        - unbuffer bash ops/travis/unit-testing/director.sh install
      before_script:
        - unbuffer bash ops/travis/unit-testing/director.sh before_script
      script:
        - unbuffer bash ops/travis/unit-testing/director.sh script
      after_success:
        - unbuffer bash ops/travis/unit-testing/director.sh after_success
      after_failure:
        - unbuffer bash ops/travis/unit-testing/director.sh after_failure

    # test python, simcore-sdk ----------------------------------------------------------------------
    - stage: unit testing
      name: simcore-sdk
      language: python
      python:
        - "3.6"
      sudo: required
      cache: pip
      before_install:
        - unbuffer sudo bash ops/travis/unit-testing/simcore-sdk.sh before_install
      install:
        - unbuffer bash ops/travis/unit-testing/simcore-sdk.sh install
      before_script:
        - unbuffer bash ops/travis/unit-testing/simcore-sdk.sh before_script
      script:
        - unbuffer bash ops/travis/unit-testing/simcore-sdk.sh script
      after_success:
        - unbuffer bash ops/travis/unit-testing/simcore-sdk.sh after_success
      after_failure:
        - unbuffer bash ops/travis/unit-testing/simcore-sdk.sh after_failure

    # test python, storage ----------------------------------------------------------------------
    - stage: unit testing
      name: storage
      language: python
      python:
        - "3.6"
      sudo: required
      services:
        - docker
      cache: pip
      before_install:
        - unbuffer sudo bash ops/travis/unit-testing/storage.sh before_install
      install:
        - unbuffer bash ops/travis/unit-testing/storage.sh install
      before_script:
        - unbuffer bash ops/travis/unit-testing/storage.sh before_script
      script:
        - unbuffer bash ops/travis/unit-testing/storage.sh script
      after_success:
        - unbuffer bash ops/travis/unit-testing/storage.sh after_success
      after_failure:
        - unbuffer bash ops/travis/unit-testing/storage.sh after_failure


    # test python, apihub ----------------------------------------------------------------------
    - stage: unit testing
      name: apihub
      language: python
      python:
        - "3.6"
      sudo: required
      cache: pip
      before_install:
        - unbuffer sudo bash ops/travis/unit-testing/apihub.sh before_install
      install:
        - unbuffer bash ops/travis/unit-testing/apihub.sh install
      before_script:
        - unbuffer bash ops/travis/unit-testing/apihub.sh before_script
      script:
        - unbuffer bash ops/travis/unit-testing/apihub.sh script
      after_success:
        - unbuffer bash ops/travis/unit-testing/apihub.sh after_success
      after_failure:
        - unbuffer bash ops/travis/unit-testing/apihub.sh after_failure

    # test python, linting ----------------------------------------------------------------------
    - stage: unit testing
      name: python linting
      language: python
      python:
        - "3.6"
      cache: pip
      before_install:
        - unbuffer sudo bash ops/travis/unit-testing/python-linting.sh before_install
      install:
        - unbuffer bash ops/travis/unit-testing/python-linting.sh install
      before_script:
        - unbuffer bash ops/travis/unit-testing/python-linting.sh before_script
      script:
        - unbuffer bash ops/travis/unit-testing/python-linting.sh script
      after_success:
        - unbuffer bash ops/travis/unit-testing/python-linting.sh after_success
      after_failure:
        - unbuffer bash ops/travis/unit-testing/python-linting.sh after_failure

    # frontend testing ----------------------------------------------------------------------
    - stage: unit testing
      name: front end testing
      language: node_js
      node_js:
        - "10"
      addons:
        apt:
          packages:
            - libgconf-2-4
#      cache:
#        directories:
#          - .npm
#          - services/web/client/node_modules
      before_install:
        - unbuffer bash ops/travis/unit-testing/frontend.sh before_install
      install:
        - unbuffer bash ops/travis/unit-testing/frontend.sh install
      before_script:
        - unbuffer bash ops/travis/unit-testing/frontend.sh before_script
      script:
        - unbuffer bash ops/travis/unit-testing/frontend.sh script
      after_success:
        - unbuffer bash ops/travis/unit-testing/frontend.sh after_success
      after_failure:
        - unbuffer bash ops/travis/unit-testing/frontend.sh after_failure

      deploy:
        # https://docs.travis-ci.com/user/deployment/pages/
        provider: pages
        target-branch: master
        # Set in travis-ci.org dashboard, marked secure
        github-token: $GH_PAGES_TOKEN
        skip-cleanup: true
        keep-history: false
        local-dir: itisfoundation.github.io
        repo: ITISFoundation/itisfoundation.github.io
        verbose: true
        on:
          branch: master


    # integrate webserver in swarm -------------------------------------------------------------
    - stage: integration testing
      name: webserver in swarm
      language: python
      python:
        - "3.6"
      sudo: required
      cache: pip
      before_install:
        - unbuffer sudo bash ops/travis/integration-testing/webserver.sh before_install
      install:
        - unbuffer bash ops/travis/integration-testing/webserver.sh install
      before_script:
        - unbuffer bash ops/travis/integration-testing/webserver.sh before_script
      script:
        - unbuffer bash ops/travis/integration-testing/webserver.sh script
      after_success:
        - unbuffer bash ops/travis/integration-testing/webserver.sh after_success
      after_failure:
        - unbuffer bash ops/travis/integration-testing/webserver.sh after_failure

    # integrate simcore-sdk in swarm -------------------------------------------------------------
    - stage: integration testing
      name: simcore-sdk in swarm
      language: python
      python:
        - "3.6"
      sudo: required
      cache: pip
      before_install:
        - unbuffer sudo bash ops/travis/integration-testing/simcore-sdk.sh before_install
      install:
        - unbuffer bash ops/travis/integration-testing/simcore-sdk.sh install
      before_script:
        - unbuffer bash ops/travis/integration-testing/simcore-sdk.sh before_script
      script:
        - unbuffer bash ops/travis/integration-testing/simcore-sdk.sh script
      after_success:
        - unbuffer bash ops/travis/integration-testing/simcore-sdk.sh after_success
      after_failure:
        - unbuffer bash ops/travis/integration-testing/simcore-sdk.sh after_failure

    - stage: system testing, staging
      sudo: required
      language: python
      python:
        - "3.6"
      cache: pip
      before_install:
        - unbuffer sudo bash ops/travis/system-testing/build_and_run.sh before_install
      install:
        - unbuffer bash ops/travis/system-testing/build_and_run.sh install
      before_script:
        - unbuffer bash ops/travis/system-testing/build_and_run.sh before_script
      script:
        - unbuffer bash ops/travis/system-testing/build_and_run.sh script
      after_success:
        - unbuffer bash ops/travis/system-testing/build_and_run.sh after_success
      after_failure:
        - unbuffer bash ops/travis/system-testing/build_and_run.sh after_failure
      deploy:
        - provider: script
          skip_cleanup: true
          script: unbuffer bash ops/travis/deploy/master.sh
          on:
            branch: master
        - provider: script
          skip_cleanup: true
          script: unbuffer bash ops/travis/deploy/staging.sh
          on:
            branch: staging
        - provider: script
          skip_cleanup: true
          script: unbuffer ops/travis/deploy/production.sh
          on:
            branch: production
notifications:
  email:
    on_success: never
    on_failure: always
