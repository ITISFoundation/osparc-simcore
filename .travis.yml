jobs:
  include:
    - if: branch = master
      stage: Build docker images
      language: python
      env:
        - DOCKER_COMPOSE_VERSION=1.23.2
        - DOCKER_GID=1042
      python:
        - "3.6"
      services:
        - docker
      before_install:
        - sudo rm /usr/local/bin/docker-compose
        - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
        - chmod +x docker-compose
        - sudo mv docker-compose /usr/local/bin
      addons:
        apt:          
          packages:
            - docker-ce
      cache: pip
      script: 
        - 'if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then bash scripts/travis/push_cache_builds; fi'

    - stage: testing
      language: node_js
      node_js:
        - "8"
      cache:
        directories:
          - .npm
      install:
        - npm install -g npm@latest
        - npm install --save-dev eslint
        - npm install --save-dev babel-eslint
        - npm install --save-dev eslint-config-qx
        - npm install --save-dev eslint-plugin-qx-rules
      before_script:
        - eslint --version
      script:
        - npm run linter

    - language: python      
      python:
        - "3.6"
      sudo: required
      env:
        - DOCKER_COMPOSE_VERSION=1.23.2
        - DOCKER_GID=1042
      services:
        - docker
        
      cache: pip

      before_install:
        - python --version
        - uname -a
        - lsb_release -a        
        - sudo rm /usr/local/bin/docker-compose
        - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
        - chmod +x docker-compose
        - sudo mv docker-compose /usr/local/bin
        - docker -v
        - docker-compose --version
        # shutdown postgres because sometimes is is already up ???
        - sudo service postgresql stop
        # wait for postgresql to shutdown
        - while sudo lsof -Pi :5432 -sTCP:LISTEN -t; do sleep 1; done
      addons:
        apt:          
          packages:
            - docker-ce

      install:
        - pip install --upgrade pip wheel setuptools && pip3 --version
        - pip3 install pytest-travis-fold
        - pip3 install packages/s3wrapper[test]
        - pip3 install packages/simcore-sdk[test]
        - pushd services/director; pip3 install -r requirements/ci.txt; popd
        - pip3 install packages/director-sdk/python
        - pushd services/web/server; pip3 install -r requirements/ci.txt; popd
        - pushd services/storage; pip3 install -r requirements/dev.txt; popd
        - pip3 install -r api/tests/requirements.txt
        - pip3 install -r services/apihub/tests/requirements.txt

      before_script:
        - pylint --version
        - pip3 list

      script:
        - make pylint       
        - make travis-build
        - make test

      after_success:
      - coveralls

      notifications:
        email:
          on_success: never
          on_failure: always
