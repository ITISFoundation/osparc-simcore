dist: xenial
env:
  global:
    - DOCKER_COMPOSE_VERSION=1.23.2
    - DOCKER_GID=1042
services:
  - docker
addons:
  apt:
    packages:
      - docker-ce


jobs:
  include:
    # build cache images ----------------------------------------------------------------------
    - if: branch = master
      stage: Build docker cache images
      language: python
      python:
        - "3.6"
      before_install:
        - bash ops/travis/build-cache/scripts before_install
      install:
        - bash ops/travis/build-cache/scripts install
      before_script:
        - bash ops/travis/build-cache/scripts before_script
      script:
        - bash ops/travis/build-cache/scripts script
      after_success:
        - bash ops/travis/build-cache/scripts after_success

    # test python, webserver ----------------------------------------------------------------------
    - stage: unit testing
      name: webserver
      language: python
      python:
        - "3.6"
      sudo: required
      cache: pip
      before_install:
        - bash ops/travis/webserver/unit-testing before_install
      install:
        - bash ops/travis/webserver/unit-testing install        
      before_script:
        - bash ops/travis/webserver/unit-testing before_script
      script:
        - bash ops/travis/webserver/unit-testing script
      after_success:
        - bash ops/travis/webserver/unit-testing after_success

    # test python, director ----------------------------------------------------------------------
    - stage: unit testing
      name: director
      language: python
      python:
        - "3.6"
      sudo: required
      cache: pip
      before_install:
        - bash ops/travis/director/unit-testing before_install
      install:
        - bash ops/travis/director/unit-testing install        
      before_script:
        - bash ops/travis/director/unit-testing before_script
      script:
        - bash ops/travis/director/unit-testing script
      after_success:
        - bash ops/travis/director/unit-testing after_success

    # test python, simcore-sdk ----------------------------------------------------------------------
    - stage: unit testing
      name: simcore-sdk
      language: python
      python:
        - "3.6"
      sudo: required
      cache: pip
      before_install:
        - bash ops/travis/simcore-sdk/unit-testing before_install
      install:
        - bash ops/travis/simcore-sdk/unit-testing install        
      before_script:
        - bash ops/travis/simcore-sdk/unit-testing before_script
      script:
        - bash ops/travis/simcore-sdk/unit-testing script
      after_success:
        - bash ops/travis/simcore-sdk/unit-testing after_success

    # test python, storage ----------------------------------------------------------------------
    - stage: unit testing
      name: storage
      language: python
      python:
        - "3.6"
      sudo: required
      services:
        - docker
      cache: pip
      before_install:
        - bash ops/travis/storage/unit-testing before_install
      install:
        - bash ops/travis/storage/unit-testing install        
      before_script:
        - bash ops/travis/storage/unit-testing before_script
      script:
        - bash ops/travis/storage/unit-testing script
      after_success:
        - bash ops/travis/storage/unit-testing after_success

    # test python, apihub ----------------------------------------------------------------------
    - stage: unit testing
      name: apihub
      language: python
      python:
        - "3.6"
      sudo: required
      cache: pip
      before_install:
        - bash ops/travis/apihub/unit-testing before_install
      install:
        - bash ops/travis/apihub/unit-testing install        
      before_script:
        - bash ops/travis/apihub/unit-testing before_script
      script:
        - bash ops/travis/apihub/unit-testing script
      after_success:
        - bash ops/travis/apihub/unit-testing after_success
    # test python, linting ----------------------------------------------------------------------
    - stage: unit testing
      name: Python linting
      language: python
      python:
        - "3.6"
      cache: pip
      before_install:
        - bash ops/travis/python-linting/unit-testing before_install
      install:
        - bash ops/travis/python-linting/unit-testing install        
      before_script:
        - bash ops/travis/python-linting/unit-testing before_script
      script:
        - bash ops/travis/python-linting/unit-testing script
      after_success:
        - bash ops/travis/python-linting/unit-testing after_success

    # test node, linting ----------------------------------------------------------------------
    - stage: unit testing
      name: node linting
      language: node_js
      node_js:
        - "8"
      cache:
        directories:
          - .npm
          - "node_modules"
      before_install:
        - bash ops/travis/node-linting/unit-testing before_install
      install:
        - bash ops/travis/node-linting/unit-testing install        
      before_script:
        - bash ops/travis/node-linting/unit-testing before_script
      script:
        - bash ops/travis/node-linting/unit-testing script
      after_success:
        - bash ops/travis/node-linting/unit-testing after_success

    # integrate apihub, webserver, director, sidecar, storage, minio, postgres, rabbit  ----------------------------------------------------------------------
    - stage: integration testing
      name: all but webserver
      language: python
      python:
        - "3.6"
      sudo: required      
      cache: pip

      before_install:
        - bash ops/travis/webserver/unit-testing before_install
      install:
        - bash ops/travis/webserver/unit-testing install        
      before_script:
        - bash ops/travis/webserver/unit-testing before_script
      script:
        - bash ops/travis/webserver/unit-testing script
      after_success:
        - bash ops/travis/webserver/unit-testing after_success

notifications:
  email:
    on_success: never
    on_failure: always
