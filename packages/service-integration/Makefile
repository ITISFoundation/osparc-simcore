#
# Targets for DEVELOPMENT of service-integration
#
# All standard targets (install-dev/prod/ci, tests/tests-ci) are defined in
# ../../scripts/common-package.Makefile and included below.
#

include ../../scripts/common.Makefile
include ../../scripts/common-package.Makefile


#
# Auto-generation and Docker-specific targets
#

compose-spec.json:
	# Downloading schema from https://github.com/compose-spec/compose-spec
	wget https://raw.githubusercontent.com/compose-spec/compose-spec/master/schema/$@
	echo $(shell cat $@ | jq '."$$schema"')



_compose_spec_model_autogenerated.py: compose-spec.json ## auto-generates pydantic model for compose-specification
	# auto-generates $@ from $<
	$(SCRIPTS_DIR)/openapi-pydantic-models-generator.bash \
			--enum-field-as-literal=all \
			--input $< \
			--output $@
	# formats and moves
	ruff format $@
	mv $@ src/service_integration/$@

generate-compose-spec-model: _compose_spec_model_autogenerated.py ## generates pydantic model for compose-specification
	@echo "Generated src/service_integration/_$<"


#
# Docker image (executable)
#

.PHONY: build build-nc
build build-nc: ## [docker] builds docker image of executable w/ or w/o cache
	# Building docker image for ${PACKAGE_NAME} ...
	@$(MAKE_C) ${REPO_BASE_DIR} $@ target=${PACKAGE_NAME}
	# Test run
	docker run local/${PACKAGE_NAME}:production --version

.PHONY: inspect
inspect: ## [docker] inspects container
	docker image inspect \
		local/${PACKAGE_NAME}:production | jq '.[0] | .RepoTags, .Config.Labels, .Architecture'


_src_dir = $(if $(target),$(target),$(PWD))

.PHONY: shell
shell: ## [docker] opens shell in container
	docker run \
		-it \
		--volume="/etc/group:/etc/group:ro" \
		--volume="/etc/passwd:/etc/passwd:ro" \
		--user="$(shell id --user "$(USER)")":scu \
		--entrypoint bash \
		--volume "$(_src_dir)":/src \
		--workdir=/src \
		local/${PACKAGE_NAME}:production
