"""resource tracker refactoring

Revision ID: 763666c698fb
Revises: 2dda922a3261
Create Date: 2023-09-05 09:44:50.592134+00:00

"""
import sqlalchemy as sa
from alembic import op
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision = '763666c698fb'
down_revision = '2dda922a3261'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###

    # Resource tracker credit transactions (NEW)
    op.create_table('resource_tracker_credit_transactions',
    sa.Column('transaction_id', sa.BigInteger(), nullable=False),
    sa.Column('product_name', sa.String(), nullable=False),
    sa.Column('wallet_id', sa.BigInteger(), nullable=False),
    sa.Column('wallet_name', sa.String(), nullable=False),
    sa.Column('pricing_plan_id', sa.BigInteger(), nullable=True),
    sa.Column('pricing_detail_id', sa.BigInteger(), nullable=True),
    sa.Column('user_id', sa.BigInteger(), nullable=False),
    sa.Column('user_email', sa.String(), nullable=False),
    sa.Column('osparc_credits', sa.Numeric(scale=2), nullable=False),
    sa.Column('transaction_status', sa.Enum('PENDING', 'BILLED', 'NOT_BILLED', 'REQUIRES_MANUAL_REVIEW', name='credittransactionstatus'), nullable=True),
    sa.Column('transaction_classification', sa.Enum('ADD_WALLET_TOP_UP', 'DEDUCT_SERVICE_RUN', name='credittransactionclassification'), nullable=True),
    sa.Column('service_run_id', sa.String(), nullable=True),
    sa.Column('payment_transaction_id', sa.String(), nullable=True),
    sa.Column('created', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('last_heartbeat_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('modified', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.PrimaryKeyConstraint('transaction_id')
    )
    op.create_index(op.f('ix_resource_tracker_credit_transactions_product_name'), 'resource_tracker_credit_transactions', ['product_name'], unique=False)
    op.create_index(op.f('ix_resource_tracker_credit_transactions_service_run_id'), 'resource_tracker_credit_transactions', ['service_run_id'], unique=False)
    op.create_index(op.f('ix_resource_tracker_credit_transactions_transaction_classification'), 'resource_tracker_credit_transactions', ['transaction_classification'], unique=False)
    op.create_index(op.f('ix_resource_tracker_credit_transactions_transaction_status'), 'resource_tracker_credit_transactions', ['transaction_status'], unique=False)
    op.create_index(op.f('ix_resource_tracker_credit_transactions_wallet_id'), 'resource_tracker_credit_transactions', ['wallet_id'], unique=False)

    # Resource tracker wallets credit transations (OLD)
    op.drop_index('ix_resource_tracker_wallets_credit_transactions_product_name', table_name='resource_tracker_wallets_credit_transactions')
    op.drop_index('ix_resource_tracker_wallets_credit_transactions_service_run_id', table_name='resource_tracker_wallets_credit_transactions')
    op.drop_index('ix_resource_tracker_wallets_credit_transactions_transac_110f', table_name='resource_tracker_wallets_credit_transactions')
    op.drop_index('ix_resource_tracker_wallets_credit_transactions_transac_e117', table_name='resource_tracker_wallets_credit_transactions')
    op.drop_index('ix_resource_tracker_wallets_credit_transactions_wallet_id', table_name='resource_tracker_wallets_credit_transactions')
    op.drop_index('ix_resource_tracker_wallets_credit_transactions_wallet_name', table_name='resource_tracker_wallets_credit_transactions')
    op.drop_table('resource_tracker_wallets_credit_transactions')

    sa.Enum(name="transactionbillingstatus").drop(op.get_bind(), checkfirst=False)
    sa.Enum(name="transactionclassification").drop(op.get_bind(), checkfirst=False)

    # Resource tracker pricing details
    op.add_column('resource_tracker_pricing_details', sa.Column('simcore_default', sa.Boolean(), nullable=False))
    # op.alter_column('resource_tracker_pricing_details', 'cost_per_unit',
    #            existing_type=sa.NUMERIC(precision=3, scale=2),
    #            nullable=False)
    op.drop_column('resource_tracker_pricing_details', 'cost_per_unit')
    op.add_column('resource_tracker_pricing_details', sa.Column('cost_per_unit', sa.NUMERIC(scale=2), nullable=False))
    op.drop_index('ix_resource_tracker_pricing_details_unit_name', table_name='resource_tracker_pricing_details')
    op.create_index(op.f('ix_resource_tracker_pricing_details_valid_to'), 'resource_tracker_pricing_details', ['valid_to'], unique=False)

    # Resource tracker pricing plan to service
    op.add_column('resource_tracker_pricing_plan_to_service', sa.Column('product', sa.String(), nullable=False))
    op.drop_constraint('resource_tracker_pricing_plan_to_service__service_unique_key', 'resource_tracker_pricing_plan_to_service', type_='unique')
    op.create_unique_constraint('rut_pricing_plan_to_service__service_product_unique_key', 'resource_tracker_pricing_plan_to_service', ['service_key', 'service_version', 'product'])

    # Resource tracker pricing plans
    op.drop_index('ix_resource_tracker_pricing_plans_name', table_name='resource_tracker_pricing_plans')

    # Resource tracker service runs
    op.drop_column('resource_tracker_service_runs', 'pricing_detail_cost_per_unit')
    op.add_column('resource_tracker_service_runs', sa.Column('pricing_detail_cost_per_unit', sa.NUMERIC(scale=2), nullable=True))

    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###

    # Resource tracker pricing plans name
    op.create_index('ix_resource_tracker_pricing_plans_name', 'resource_tracker_pricing_plans', ['name'], unique=False)

    # Resource tracker pricing plan to service
    op.drop_constraint('rut_pricing_plan_to_service__service_product_unique_key', 'resource_tracker_pricing_plan_to_service', type_='unique')
    op.create_unique_constraint('resource_tracker_pricing_plan_to_service__service_unique_key', 'resource_tracker_pricing_plan_to_service', ['service_key', 'service_version'])
    op.drop_column('resource_tracker_pricing_plan_to_service', 'product')

    # Resource tracker pricing details
    op.drop_index(op.f('ix_resource_tracker_pricing_details_valid_to'), table_name='resource_tracker_pricing_details')
    op.create_index('ix_resource_tracker_pricing_details_unit_name', 'resource_tracker_pricing_details', ['unit_name'], unique=False)
    op.drop_column('resource_tracker_pricing_details', 'cost_per_unit')
    op.add_column('resource_tracker_pricing_details', sa.Column('cost_per_unit', sa.NUMERIC(precision=3, scale=2), nullable=False))
    op.drop_column('resource_tracker_pricing_details', 'simcore_default')

    # Resource tracker wallets credit transations
    op.create_table('resource_tracker_wallets_credit_transactions',
    sa.Column('transaction_id', sa.BIGINT(), autoincrement=True, nullable=False),
    sa.Column('product_name', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('wallet_id', sa.BIGINT(), autoincrement=False, nullable=False),
    sa.Column('wallet_name', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('user_id', sa.BIGINT(), autoincrement=False, nullable=False),
    sa.Column('user_email', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('credits', sa.NUMERIC(precision=3, scale=2), autoincrement=False, nullable=False),
    sa.Column('transaction_status', postgresql.ENUM('PENDING', 'BILLED', 'NOT_BILLED', 'REQUIRES_MANUAL_REVIEW', name='transactionbillingstatus'), autoincrement=False, nullable=True),
    sa.Column('transaction_classification', postgresql.ENUM('ADD_WALLET_TOP_UP', 'DEDUCT_SERVICE_RUN', name='transactionclassification'), autoincrement=False, nullable=True),
    sa.Column('service_run_id', sa.BIGINT(), autoincrement=False, nullable=True),
    sa.Column('modified', postgresql.TIMESTAMP(timezone=True), server_default=sa.text('now()'), autoincrement=False, nullable=False),
    sa.PrimaryKeyConstraint('transaction_id', name='resource_tracker_wallets_credit_transactions_pkey')
    )
    op.create_index('ix_resource_tracker_wallets_credit_transactions_wallet_name', 'resource_tracker_wallets_credit_transactions', ['wallet_name'], unique=False)
    op.create_index('ix_resource_tracker_wallets_credit_transactions_wallet_id', 'resource_tracker_wallets_credit_transactions', ['wallet_id'], unique=False)
    op.create_index('ix_resource_tracker_wallets_credit_transactions_transac_e117', 'resource_tracker_wallets_credit_transactions', ['transaction_status'], unique=False)
    op.create_index('ix_resource_tracker_wallets_credit_transactions_transac_110f', 'resource_tracker_wallets_credit_transactions', ['transaction_classification'], unique=False)
    op.create_index('ix_resource_tracker_wallets_credit_transactions_service_run_id', 'resource_tracker_wallets_credit_transactions', ['service_run_id'], unique=False)
    op.create_index('ix_resource_tracker_wallets_credit_transactions_product_name', 'resource_tracker_wallets_credit_transactions', ['product_name'], unique=False)

    # Resource tracker credit transactions
    op.drop_index(op.f('ix_resource_tracker_credit_transactions_wallet_id'), table_name='resource_tracker_credit_transactions')
    op.drop_index(op.f('ix_resource_tracker_credit_transactions_transaction_status'), table_name='resource_tracker_credit_transactions')
    op.drop_index(op.f('ix_resource_tracker_credit_transactions_transaction_classification'), table_name='resource_tracker_credit_transactions')
    op.drop_index(op.f('ix_resource_tracker_credit_transactions_service_run_id'), table_name='resource_tracker_credit_transactions')
    op.drop_index(op.f('ix_resource_tracker_credit_transactions_product_name'), table_name='resource_tracker_credit_transactions')
    op.drop_table('resource_tracker_credit_transactions')

    sa.Enum(name="credittransactionstatus").drop(op.get_bind(), checkfirst=False)
    sa.Enum(name="credittransactionclassification").drop(op.get_bind(), checkfirst=False)

    # Resource tracker service runs
    op.drop_column('resource_tracker_service_runs', 'pricing_detail_cost_per_unit')
    op.add_column('resource_tracker_service_runs', sa.Column('pricing_detail_cost_per_unit', sa.NUMERIC(precision=15, scale=2), nullable=True))

    # ### end Alembic commands ###
