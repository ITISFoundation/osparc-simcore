"""add products table, add service access rights linked to product

Revision ID: c47b9013101a
Revises: 43766dcf0fc2
Create Date: 2020-09-11 13:50:55.000337+00:00

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision = "c47b9013101a"
down_revision = "43766dcf0fc2"
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table(
        "products",
        sa.Column("name", sa.String(), nullable=False),
        sa.Column(
            "urls",
            postgresql.ARRAY(sa.String(), dimensions=1),
            server_default="{}",
            nullable=False,
        ),
        sa.Column("frontend", sa.String(), nullable=False),
        sa.Column(
            "created", sa.DateTime(), server_default=sa.text("now()"), nullable=False
        ),
        sa.Column(
            "modified", sa.DateTime(), server_default=sa.text("now()"), nullable=False
        ),
        sa.PrimaryKeyConstraint("name", name="products_pk"),
    )
    op.execute(
        "INSERT INTO products (name, urls, frontend) VALUES ('osparc', '{\"osparc.io\"}', 'osparc')"
    )
    op.add_column(
        "services_access_rights", sa.Column("product_name", sa.String(), nullable=False, server_default="osparc")
    )
    op.create_foreign_key(
        "fk_services_name_products",
        "services_access_rights",
        "products",
        ["product_name"],
        ["name"],
        onupdate="CASCADE",
        ondelete="CASCADE",
    )
    # ### end Alembic commands ###
    op.drop_constraint("services_access_pk", "services_access_rights", type_="primary")
    op.create_primary_key(
        "services_access_pk",
        "services_access_rights",
        ["key", "version", "gid", "product_name"],
    )


def downgrade():
    op.drop_constraint("services_access_pk", "services_access_rights", type_="primary")
    op.create_primary_key(
        "services_access_pk",
        "services_access_rights",
        ["key", "version", "gid"],
    )
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_constraint(
        "fk_services_name_products", "services_access_rights", type_="foreignkey"
    )
    op.drop_column("services_access_rights", "product_name")
    op.drop_table("products")
    # ### end Alembic commands ###
