"""computational collection runs

Revision ID: 42ec7816c0b4
Revises: 4f6fd2586491
Create Date: 2025-07-01 13:30:02.736058+00:00

"""

import sqlalchemy as sa
from alembic import op
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision = "42ec7816c0b4"
down_revision = "4f6fd2586491"
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table(
        "comp_run_collections",
        sa.Column(
            "collection_run_id",
            postgresql.UUID(as_uuid=True),
            server_default=sa.text("gen_random_uuid()"),
            nullable=False,
        ),
        sa.Column("client_or_system_generated_id", sa.String(), nullable=False),
        sa.Column(
            "client_or_system_generated_display_name", sa.String(), nullable=False
        ),
        sa.Column("generated_by_system", sa.Boolean(), nullable=False),
        sa.Column(
            "created",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "modified",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.PrimaryKeyConstraint("collection_run_id"),
    )
    op.create_index(
        "ix_comp_run_collections_client_or_system_generated_id",
        "comp_run_collections",
        ["client_or_system_generated_id"],
        unique=False,
    )
    op.add_column(
        "comp_runs", sa.Column("collection_run_id", sa.String(), nullable=False)
    )

    # Data migration: Create collection run records for existing comp_runs
    op.execute(
        """
        INSERT INTO comp_run_collections (
            collection_run_id,
            client_or_system_generated_id,
            client_or_system_generated_display_name,
            generated_by_system
        )
        SELECT DISTINCT
            gen_random_uuid(),
            'migration-generated-' || run_id::text,
            'Migration Generated Collection Run',
            TRUE
        FROM comp_runs
        WHERE collection_run_id IS NULL
        """
    )

    # Update comp_runs to reference the newly created collection runs
    op.execute(
        """
        UPDATE comp_runs
        SET collection_run_id = (
            SELECT collection_run_id::text
            FROM comp_run_collections
            WHERE client_or_system_generated_id LIKE 'migration-generated-%'
            LIMIT 1
        )
        WHERE collection_run_id IS NULL
        """
    )

    op.alter_column(
        "comp_runs",
        "collection_run_id",
        existing_type=sa.String(),
        nullable=False,
    )

    op.create_index(
        "ix_comp_runs_collection_run_id",
        "comp_runs",
        ["collection_run_id"],
        unique=False,
    )
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index("ix_comp_runs_collection_run_id", table_name="comp_runs")
    op.drop_column("comp_runs", "collection_run_id")
    op.drop_index(
        "ix_comp_run_collections_client_or_system_generated_id",
        table_name="comp_run_collections",
    )
    op.drop_table("comp_run_collections")
    # ### end Alembic commands ###
